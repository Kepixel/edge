var kepixelAnalytics=function(e){"use strict";function t(e){return null!=e&&"object"==typeof e&&!0===e["@@functional/placeholder"]}function i(e){return function i(n){return 0===arguments.length||t(n)?i:e.apply(this,arguments)}}function n(e){return function n(r,s){switch(arguments.length){case 0:return n;case 1:return t(r)?n:i(function(t){return e(r,t)});default:return t(r)&&t(s)?n:t(r)?i(function(t){return e(t,s)}):t(s)?i(function(t){return e(r,t)}):e(r,s)}}}function r(e){return function r(s,a,o){switch(arguments.length){case 0:return r;case 1:return t(s)?r:n(function(t,i){return e(s,t,i)});case 2:return t(s)&&t(a)?r:t(s)?n(function(t,i){return e(t,a,i)}):t(a)?n(function(t,i){return e(s,t,i)}):i(function(t){return e(s,a,t)});default:return t(s)&&t(a)&&t(o)?r:t(s)&&t(a)?n(function(t,i){return e(t,i,o)}):t(s)&&t(o)?n(function(t,i){return e(t,a,i)}):t(a)&&t(o)?n(function(t,i){return e(s,t,i)}):t(s)?i(function(t){return e(t,a,o)}):t(a)?i(function(t){return e(s,t,o)}):t(o)?i(function(t){return e(s,a,t)}):e(s,a,o)}}}function s(e,t){return Object.prototype.hasOwnProperty.call(t,e)}var a=i(function(e){return null===e?"Null":void 0===e?"Undefined":Object.prototype.toString.call(e).slice(8,-1)});function o(e){return"[object Object]"===Object.prototype.toString.call(e)}let l=Number.isInteger||function(e){return(0|e)===e};function u(e,t){var i,n=e<0?t.length+e:e;return i=t,"[object String]"===Object.prototype.toString.call(i)?t.charAt(n):t[n]}var c=function(){function e(){this.map={},this.length=0}return e.prototype.set=function(e,t){var i=this.hash(e),n=this.map[i];n||(this.map[i]=n=[]),n.push([e,t]),this.length+=1},e.prototype.hash=function(e){var t=[];for(var i in e)t.push(Object.prototype.toString.call(e[i]));return t.join()},e.prototype.get=function(e){if(this.length<=180){for(var t in this.map)for(var i=this.map[t],n=0;n<i.length;n+=1)if((r=i[n])[0]===e)return r[1]}else{var r,s=this.hash(e);if(i=this.map[s]){for(n=0;n<i.length;n+=1)if((r=i[n])[0]===e)return r[1]}}},e}(),d=i(function(e){return null!=e&&"function"==typeof e.clone?e.clone():function e(t,i,n){if(n||(n=new c),s=typeof(r=t),null==r||"object"!=s&&"function"!=s)return t;var r,s,o,l=function(i){var r=n.get(t);if(r)return r;for(var s in n.set(t,i),t)Object.prototype.hasOwnProperty.call(t,s)&&(i[s]=e(t[s],!0,n));return i};switch(a(t)){case"Object":return l(Object.create(Object.getPrototypeOf(t)));case"Array":return l(Array(t.length));case"Date":return new Date(t.valueOf());case"RegExp":return o=t,RegExp(o.source,o.flags?o.flags:(o.global?"g":"")+(o.ignoreCase?"i":"")+(o.multiline?"m":"")+(o.sticky?"y":"")+(o.unicode?"u":"")+(o.dotAll?"s":""));case"Int8Array":case"Uint8Array":case"Uint8ClampedArray":case"Int16Array":case"Uint16Array":case"Int32Array":case"Uint32Array":case"Float32Array":case"Float64Array":case"BigInt64Array":case"BigUint64Array":return t.slice();default:return t}}(e)}),g=r(function(e,t,i){var n,r={};for(n in i=i||{},t=t||{})s(n,t)&&(r[n]=s(n,i)?e(n,t[n],i[n]):t[n]);for(n in i)s(n,i)&&!s(n,r)&&(r[n]=i[n]);return r}),h=r(function e(t,i,n){return g(function(i,n,r){return o(n)&&o(r)?e(t,n,r):t(i,n,r)},i,n)}),p=r(function(e,t,i){return h(function(t,i,n){return e(i,n)},t,i)}),v=n(function(e,t){for(var i=t,n=0;n<e.length;n+=1){if(null==i)return;var r=e[n];i=l(r)?u(r,i):i[r]}return i}),f=n(function(e,t){var i={};for(var n in t)e(t[n],n,t)&&(i[n]=t[n]);return i});let y=e=>"function"==typeof e&&Boolean(e.constructor&&e.call&&e.apply),m=e=>"string"==typeof e,b=e=>null===e,k=e=>void 0===e,$=e=>b(e)||k(e),I=e=>!k(e),S=e=>!$(e),E=e=>{switch(Object.prototype.toString.call(e)){case"[object Error]":case"[object Exception]":case"[object DOMException]":return!0;default:return e instanceof Error}},A=(e,t)=>v(t.split("."),e),w=e=>!b(e)&&"[object Object]"===Object.prototype.toString.call(e),T=(e,t)=>{if(!Array.isArray(e)||!Array.isArray(t))return d(t);let i=d(e);return t.forEach((e,t)=>{var n;i[t]=!Array.isArray(e)&&(b(n=e)||"object"!=typeof n||Array.isArray(n))?e:P(i[t],e)}),i},P=(e,t)=>p(T,e,t),C=e=>w(e)&&Object.keys(e).length>0,_=e=>{let t=f(I,e);return Object.keys(t).forEach(e=>{let i=t[e];w(i)&&(t[e]=_(i))}),t},D=e=>{let t=f(S,e);return Object.keys(t).forEach(e=>{let i=t[e];w(i)&&(t[e]=D(i))}),t},x=e=>{if(C(e))return D(e)},O=(e,t)=>"boolean"==typeof e?e:t,R=e=>e.replace(/^\.+/,""),M=e=>{let t=e;if(!m(e)&&!$(e))try{t=JSON.stringify(e)}catch(i){t=null}return t},N=(e,t,i,n,r)=>{let s={category:e,name:t,properties:i,options:n,callback:void 0};y(r)&&(s.callback=r),y(n)&&(s.category=e,s.name=t,s.properties=i,s.options=void 0,s.callback=n),y(i)&&(s.category=e,s.name=t,s.properties=void 0,s.options=void 0,s.callback=i),y(t)&&(s.category=e,s.name=void 0,s.properties=void 0,s.options=void 0,s.callback=t),y(e)&&(s.category=void 0,s.name=void 0,s.properties=void 0,s.options=void 0,s.callback=e),w(e)?(s.name=void 0,s.category=void 0,s.properties=e,y(t)?s.options=void 0:s.options=t):w(t)&&(s.name=void 0,s.properties=t,y(i)?s.options=void 0:s.options=i),m(e)&&!m(t)&&(s.category=void 0,s.name=e),I(s.category)||(s.category=void 0),I(s.name)||(s.name=void 0),s.properties=s.properties?d(s.properties):{},I(s.options)?s.options=d(s.options):s.options=void 0;let a=m(s.name)?s.name:s.properties.name,o=m(s.category)?s.category:s.properties.category;return s.properties=P(w(s.properties)?s.properties:{},{...a&&{name:a},...o&&{category:o}}),s},L=(e,t,i,n)=>{let r={name:e,properties:t,options:i,callback:void 0};return y(n)&&(r.callback=n),y(i)&&(r.properties=t,r.options=void 0,r.callback=i),y(t)&&(r.properties=void 0,r.options=void 0,r.callback=t),r.properties=S(r.properties)?d(r.properties):{},I(r.options)?r.options=d(r.options):r.options=void 0,r},B=(e,t,i,n)=>{let r={userId:e,traits:t,options:i,callback:void 0};return y(n)&&(r.callback=n),y(i)&&(r.userId=e,r.traits=t,r.options=void 0,r.callback=i),y(t)&&(r.userId=e,r.traits=void 0,r.options=void 0,r.callback=t),(w(e)||b(e))&&(r.userId=null,r.traits=e,y(t)?r.options=void 0:r.options=t),r.userId=M(r.userId),w(r.traits)?r.traits=d(r.traits):r.traits=void 0,I(r.options)?r.options=d(r.options):r.options=void 0,r},U=(e,t,i,n)=>{let r={to:e,from:t,options:i,callback:void 0};return y(n)&&(r.callback=n),y(i)&&(r.to=e,r.from=t,r.options=void 0,r.callback=i),y(t)?(r.to=e,r.from=void 0,r.options=void 0,r.callback=t):(w(t)||b(t))&&(r.to=e,r.from=void 0,r.options=t),I(r.to)&&(r.to=M(r.to)),I(r.from)?r.from=M(r.from):r.from=void 0,I(r.options)?r.options=d(r.options):r.options=void 0,r},H=(e,t,i,n)=>{let r={groupId:e,traits:t,options:i,callback:void 0};return y(n)&&(r.callback=n),y(i)&&(r.groupId=e,r.traits=t,r.options=void 0,r.callback=i),y(t)&&(r.groupId=e,r.traits=void 0,r.options=void 0,r.callback=t),(w(e)||b(e))&&(r.groupId=null,r.traits=e,y(t)?r.options=void 0:r.options=t),r.groupId=M(r.groupId),w(r.traits)?r.traits=d(r.traits):r.traits=void 0,I(r.options)?r.options=d(r.options):r.options=void 0,r},K=((J={}).UNLOADED="Page Unloaded",J),F="CapabilitiesManager",j="ConfigManager",G="EventManager",V="PluginsManager",Q="UserSessionManager",z="ErrorHandler",q="PluginEngine",W="ReadyAPI",X="AnalyticsCore";for(var J,Z,Y=[],ee=0;ee<256;ee++)Y[ee]=(ee+256).toString(16).substring(1);for(var et,ei=256,en=[];ei--;)en[ei]=(ei+256).toString(16).substring(1);let er=()=>!$(globalThis.crypto)&&y(globalThis.crypto.getRandomValues)?function(){(!Z||ee+16>4096)&&(Z=crypto.getRandomValues(new Uint8Array(4096)),ee=0);for(var e,t=0,i="";t<16;t++)e=Z[ee+t],i+=6==t?Y[15&e|64]:8==t?Y[63&e|128]:Y[e],1&t&&t>1&&t<11&&(i+="-");return ee+=16,i}():function(){var e,t=0,i="";if(!et||ei+16>256){for(et=Array(t=256);t--;)et[t]=256*Math.random()|0;t=ei=0}for(;t<16;t++)e=et[ei+t],i+=6==t?en[15&e|64]:8==t?en[63&e|128]:en[e],1&t&&t>1&&t<11&&(i+="-");return ei++,i}(),es=e=>e.toISOString(),ea=(e,t,i)=>`Unable to load (${m(i)?i:i.type}) the script with the id "${e}" from URL "${t}"`,eo="[Circular Reference]",el=(e,t,i)=>{let n=[];return function(r,s){if(!(t?.includes(r)||e&&$(s))){if("object"!=typeof s||b(s))return s;for(;n.length>0&&n[n.length-1]!==this;)n.pop();return n.includes(s)?(i?.warn(`JSONStringify:: A circular reference has been detected in the object and the property "${r}" has been dropped from the output.`),eo):(n.push(s),s)}}},eu=(e,t,i,n)=>{try{return JSON.stringify(e,el(t,i,n))}catch(r){return n?.warn("Failed to convert the value to a JSON string.",r),null}},ec=e=>{let t=[];return function(e,i){if("bigint"==typeof i)return"[BigInt]";for(;t.length>0&&t[t.length-1]!==this;)t.pop();return t.includes(i)?eo:(t.push(i),i)}},ed=(e,t)=>{let i=Array.isArray(e)?[]:{};for(let n in e)if(Object.hasOwnProperty.call(e,n)){let r=e[n],s=t.call(e,n,r);w(s)||Array.isArray(s)?i[n]=ed(s,t):i[n]=s}return i},eg=(e,t)=>{let i=ec(),n=i.call(e,"",e);return w(e)||Array.isArray(e)?ed(e,i):n},eh="[SDK DISPATCHED ERROR]",ep=e=>{let{stack:t,stacktrace:i}=e,n=e["opera#sourceloc"],r=t??i??n;if(r&&"string"==typeof r)return r},ev=(e,t)=>{let i=e;return E(e)?i.message=`${t}: ${e.message}`:i=Error(`${t}: ${eu(e)}`),i},ef=e=>{if(E(e)){let t=ep(e);if(t){let{stack:i,stacktrace:n}=e,r=e["opera#sourceloc"];switch(t){case i:e.stack=`${i}
${eh}`;break;case n:e.stacktrace=`${n}
${eh}`;break;default:e["opera#sourceloc"]=`${r}
${eh}`}}}globalThis.dispatchEvent(new ErrorEvent("error",{error:e,bubbles:!0,cancelable:!0,composed:!0}))},ey="KePixel JavaScript SDK",em="3.21.0",eb="KePixelJS-Initiated",ek="preloadedEventsBuffer",e$="ajs_aid",eI="ajs_uid",eS="ajs_event",eE=(e="app")=>{globalThis.KePixelStackGlobals||(globalThis.KePixelStackGlobals={}),globalThis.KePixelStackGlobals[e]||(globalThis.KePixelStackGlobals[e]={})},eA=(e,t,i="app")=>{eE(i),globalThis.KePixelStackGlobals[i][e]=t},ew=(e,t="app")=>(eE(t),globalThis.KePixelStackGlobals[t][e]),eT=(e,t)=>{let i={};return e.forEach((n,r)=>{r.startsWith(t)&&(i[r.substring(t.length)]=e.get(r))}),i},eP=(e,t)=>{let i,n=e.shift();if(y(t[n])){switch(n){case"page":i=N(...e);break;case"track":i=L(...e);break;case"identify":i=B(...e);break;case"alias":i=U(...e);break;case"group":i=H(...e);break;default:t[n](...e)}i&&t[n](i)}};class eC{constructor(e,t=1e4){this.logger=e,this.timeout=t}loadJSFile(e){let{url:t,id:i,timeout:n,async:r,callback:s,extraAttributes:a}=e,o=!y(s);((e,t,i,n=!0,r)=>new Promise((s,a)=>{document.getElementById(t)&&a(Error(`A script with the id "${t}" is already loaded. Skipping the loading of this script to prevent conflicts`));try{let o;(e=>{let t=document.getElementsByTagName("head");if(t.length>0)return void t[0]?.insertBefore(e,t[0]?.firstChild);let i=document.getElementsByTagName("script");if(i.length>0&&i[0]?.parentNode)return void i[0]?.parentNode.insertBefore(e,i[0]);let n=document.createElement("head");n.appendChild(e);let r=document.getElementsByTagName("html")[0];r?.insertBefore(n,r.firstChild)})(((e,t,i=!0,n=null,r=null,s={})=>{let a=document.createElement("script");return a.type="text/javascript",a.onload=n,a.onerror=r,a.src=e,a.id=t,a.async=i,Object.keys(s).forEach(e=>{a.setAttribute(e,s[e])}),a.setAttribute("data-loader","RS_JS_SDK"),a})(e,t,n,()=>{globalThis.clearTimeout(o),s(t)},i=>{globalThis.clearTimeout(o),a(Error(ea(t,e,i)))},r)),o=globalThis.setTimeout(()=>{a(Error(`A timeout of ${i} ms occurred while trying to load the script with id "${t}" from URL "${e}"`))},i)}catch(l){a(ev(l,ea(t,e,"unknown")))}}))(t,i,n||this.timeout,r,a).then(e=>{o||s(e)}).catch(e=>{o||s(i,e)})}}var e_=Symbol.for("preact-signals");function eD(){if(eM>1)eM--;else{for(var e,t=!1;void 0!==eR;){var i=eR;for(eR=void 0,eN++;void 0!==i;){var n=i.o;if(i.o=void 0,i.f&=-3,!(8&i.f)&&eH(i))try{i.c()}catch(r){t||(e=r,t=!0)}i=n}}if(eN=0,eM--,t)throw e}}function e9(e){if(eM>0)return e();eM++;try{return e()}finally{eD()}}var ex=void 0;function eO(e){var t=ex;ex=void 0;try{return e()}finally{ex=t}}var eR=void 0,eM=0,eN=0,eL=0;function eB(e){if(void 0!==ex){var t=e.n;if(void 0===t||t.t!==ex)return t={i:0,S:e,p:ex.s,n:void 0,t:ex,e:void 0,x:void 0,r:t},void 0!==ex.s&&(ex.s.n=t),ex.s=t,e.n=t,32&ex.f&&e.S(t),t;if(-1===t.i)return t.i=0,void 0!==t.n&&(t.n.p=t.p,void 0!==t.p&&(t.p.n=t.n),t.p=ex.s,t.n=void 0,ex.s.n=t,ex.s=t),t}}function e8(e,t){this.v=e,this.i=0,this.n=void 0,this.t=void 0,this.W=null==t?void 0:t.watched,this.Z=null==t?void 0:t.unwatched}function eU(e,t){return new e8(e,t)}function eH(e){for(var t=e.s;void 0!==t;t=t.n)if(t.S.i!==t.i||!t.S.h()||t.S.i!==t.i)return!0;return!1}function eK(e){for(var t=e.s;void 0!==t;t=t.n){var i=t.S.n;if(void 0!==i&&(t.r=i),t.S.n=t,t.i=-1,void 0===t.n){e.s=t;break}}}function eF(e){for(var t=e.s,i=void 0;void 0!==t;){var n=t.p;-1===t.i?(t.S.U(t),void 0!==n&&(n.n=t.n),void 0!==t.n&&(t.n.p=n)):i=t,t.S.n=t.r,void 0!==t.r&&(t.r=void 0),t=n}e.s=i}function ej(e,t){e8.call(this,void 0),this.x=e,this.s=void 0,this.g=eL-1,this.f=4,this.W=null==t?void 0:t.watched,this.Z=null==t?void 0:t.unwatched}function e0(e){var t=e.u;if(e.u=void 0,"function"==typeof t){eM++;var i=ex;ex=void 0;try{t()}catch(n){throw e.f&=-2,e.f|=8,eG(e),n}finally{ex=i,eD()}}}function eG(e){for(var t=e.s;void 0!==t;t=t.n)t.S.U(t);e.x=void 0,e.s=void 0,e0(e)}function eV(e){if(ex!==this)throw Error("Out-of-order effect");eF(this),ex=e,this.f&=-2,8&this.f&&eG(this),eD()}function eQ(e){this.x=e,this.u=void 0,this.s=void 0,this.o=void 0,this.f=32}function ez(e){var t=new eQ(e);try{t.c()}catch(i){throw t.d(),i}return t.d.bind(t)}e8.prototype.brand=e_,e8.prototype.h=function(){return!0},e8.prototype.S=function(e){var t=this,i=this.t;i!==e&&void 0===e.e&&(e.x=i,this.t=e,void 0!==i?i.e=e:eO(function(){var e;null==(e=t.W)||e.call(t)}))},e8.prototype.U=function(e){var t=this;if(void 0!==this.t){var i=e.e,n=e.x;void 0!==i&&(i.x=n,e.e=void 0),void 0!==n&&(n.e=i,e.x=void 0),e===this.t&&(this.t=n,void 0===n&&eO(function(){var e;null==(e=t.Z)||e.call(t)}))}},e8.prototype.subscribe=function(e){var t=this;return ez(function(){var i=t.value,n=ex;ex=void 0;try{e(i)}finally{ex=n}})},e8.prototype.valueOf=function(){return this.value},e8.prototype.toString=function(){return this.value+""},e8.prototype.toJSON=function(){return this.value},e8.prototype.peek=function(){var e=ex;ex=void 0;try{return this.value}finally{ex=e}},Object.defineProperty(e8.prototype,"value",{get:function(){var e=eB(this);return void 0!==e&&(e.i=this.i),this.v},set:function(e){if(e!==this.v){if(eN>100)throw Error("Cycle detected");this.v=e,this.i++,eL++,eM++;try{for(var t=this.t;void 0!==t;t=t.x)t.t.N()}finally{eD()}}}}),ej.prototype=new e8,ej.prototype.h=function(){if(this.f&=-3,1&this.f)return!1;if(32==(36&this.f)||(this.f&=-5,this.g===eL))return!0;if(this.g=eL,this.f|=1,this.i>0&&!eH(this))return this.f&=-2,!0;var e=ex;try{eK(this),ex=this;var t=this.x();(16&this.f||this.v!==t||0===this.i)&&(this.v=t,this.f&=-17,this.i++)}catch(i){this.v=i,this.f|=16,this.i++}return ex=e,eF(this),this.f&=-2,!0},ej.prototype.S=function(e){if(void 0===this.t){this.f|=36;for(var t=this.s;void 0!==t;t=t.n)t.S.S(t)}e8.prototype.S.call(this,e)},ej.prototype.U=function(e){if(void 0!==this.t&&(e8.prototype.U.call(this,e),void 0===this.t)){this.f&=-33;for(var t=this.s;void 0!==t;t=t.n)t.S.U(t)}},ej.prototype.N=function(){if(!(2&this.f)){this.f|=6;for(var e=this.t;void 0!==e;e=e.x)e.t.N()}},Object.defineProperty(ej.prototype,"value",{get:function(){if(1&this.f)throw Error("Cycle detected");var e=eB(this);if(this.h(),void 0!==e&&(e.i=this.i),16&this.f)throw this.v;return this.v}}),eQ.prototype.c=function(){var e=this.S();try{if(8&this.f||void 0===this.x)return;var t=this.x();"function"==typeof t&&(this.u=t)}finally{e()}},eQ.prototype.S=function(){if(1&this.f)throw Error("Cycle detected");this.f|=1,this.f&=-9,e0(this),eK(this),eM++;var e=ex;return ex=this,eV.bind(this,e)},eQ.prototype.N=function(){2&this.f||(this.f|=2,this.o=eR,eR=this)},eQ.prototype.d=function(){this.f|=8,1&this.f||eG(this)},eQ.prototype.dispose=function(){this.d()};let e1={LOG:0,INFO:1,DEBUG:2,WARN:3,ERROR:4,NONE:5},e4="ERROR",eq=new class{constructor(e="LOG",t="",i=console){this.minLogLevel=e1[e],this.scope=t,this.logProvider=i}log(...e){this.outputLog("LOG",e)}info(...e){this.outputLog("INFO",e)}debug(...e){this.outputLog("DEBUG",e)}warn(...e){this.outputLog("WARN",e)}error(...e){this.outputLog("ERROR",e)}outputLog(e,t){this.minLogLevel<=e1[e]&&this.logProvider[e.toLowerCase()]?.(...this.formatLogData(t))}setScope(e){this.scope=e||this.scope}setMinLogLevel(e){this.minLogLevel=e1[e],k(this.minLogLevel)&&(this.minLogLevel=e1.LOG)}formatLogData(e){if(Array.isArray(e)&&e.length>0){let t="%c KE SDK";this.scope&&(t=`${t} - ${this.scope}`);let i=[t=`${t} %c ${m(e[0])?e[0].trim():""}`,"font-weight: bold; background: black; color: white;","font-weight: normal;"];return m(e[0])||i.push(e[0]),i.push(...e.slice(1)),i}return e}},eW=((t_={}).HANDLEDEXCEPTION="handledException",t_.UNHANDLEDEXCEPTION="unhandledException",t_.UNHANDLEDREJECTION="unhandledPromiseRejection",t_),e2=["localStorage","memoryStorage","cookieStorage","sessionStorage","none"],e3="cookieStorage",e6="Unable to process/parse source configuration response",eX="Failed to log breadcrumb",eJ="Failed to fetch the source config",eZ=e=>`${e}:: The provided callback parameter is not a function.`,e7=(e,t,i)=>`${e} due to timeout or no connection (${t?t.type:""}) at the client side for URL: ${i}`,e5="Failed to set/remove cookies via server. As a fallback, the cookies will be managed client side.",eY={All:!0},te="js-integrations",tt="plugins",ti=RegExp("^(https?:\\/\\/)(((([a-zA-Z\\d]([a-zA-Z\\d-]*[a-zA-Z\\d])*)\\.)+[a-zA-Z]{2,}|localhost|((25[0-5]|2[0-4][0-9]|[0-1]?[0-9]?[0-9]?)\\.){3}(25[0-5]|2[0-4][0-9]|[0-1]?[0-9]?[0-9]?)))(\\:\\d+)?(\\/[-a-zA-Z\\d%_.~+]*)*(\\?[;&a-zA-Z\\d%_.~+=-]*)?(\\#[-a-zA-Z\\d_]*)?$"),tn="modern",tr="https://cdn.kepixel.com",ts=`${tr}/v3/${tn}/${te}`,ta=`${tr}/v3/${tn}/${tt}`,to="https://source-config.kepixel.com",tl={iubenda:"IubendaConsentManager",oneTrust:"OneTrustConsentManager",ketch:"KetchConsentManager",custom:"CustomConsentManager"},tu={v3:"StorageEncryption",legacy:"StorageEncryptionLegacy"},tc={xhr:"XhrQueue",beacon:"BeaconQueue"},td=eU(d({configUrl:to,loadIntegration:!0,sessions:{autoTrack:!0,timeout:18e5,cutOff:{enabled:!1}},sameSiteCookie:"Lax",polyfillIfRequired:!0,integrations:eY,useBeacon:!1,beaconQueueOptions:{},destinationsQueueOptions:{},queueOptions:{},lockIntegrationsVersion:!0,lockPluginsVersion:!0,uaChTrackLevel:"none",plugins:[],useGlobalIntegrationsConfigInEvents:!1,bufferDataPlaneEventsUntilReady:!1,dataPlaneEventsBufferTimeout:1e4,storage:{encryption:{version:"v3"},migrate:!0,cookie:{}},sendAdblockPage:!1,sameDomainCookiesOnly:!1,secureCookie:!1,sendAdblockPageOptions:{},useServerSideCookies:!1})),tg={userId:"",userTraits:{},anonymousId:"",groupId:"",groupTraits:{},initialReferrer:"",initialReferringDomain:"",sessionInfo:{},authToken:null},th={userId:eU(tg.userId),userTraits:eU(tg.userTraits),anonymousId:eU(tg.anonymousId),groupId:eU(tg.groupId),groupTraits:eU(tg.groupTraits),initialReferrer:eU(tg.initialReferrer),initialReferringDomain:eU(tg.initialReferringDomain),sessionInfo:eU(tg.sessionInfo),authToken:eU(tg.authToken)},tp={isOnline:eU(!0),storage:{isLocalStorageAvailable:eU(!1),isCookieStorageAvailable:eU(!1),isSessionStorageAvailable:eU(!1)},isBeaconAvailable:eU(!1),isLegacyDOM:eU(!1),isUaCHAvailable:eU(!1),isCryptoAvailable:eU(!1),isIE11:eU(!1),isAdBlockerDetectionInProgress:eU(!1),isAdBlocked:eU(void 0),cspBlockedURLs:eU([])},tv={isErrorReportingEnabled:eU(!1),isMetricsReportingEnabled:eU(!1),breadcrumbs:eU([])},tf=eU(void 0),ty={activeDataplaneUrl:eU(void 0),integrationsCDNPath:eU(ts),pluginsCDNPath:eU(ta),sourceConfigUrl:eU(void 0),status:eU(void 0),initialized:eU(!1),logLevel:eU(e4),loaded:eU(!1),readyCallbacks:eU([]),writeKey:eU(void 0),dataPlaneUrl:eU(void 0)},tm={enabled:eU(!1),initialized:eU(!1),data:eU({}),activeConsentManagerPluginName:eU(void 0),preConsent:eU({enabled:!1}),postConsent:eU({}),resolutionStrategy:eU("and"),provider:eU(void 0),metadata:eU(void 0)},tb={retries:eU(0),dropped:eU(0),sent:eU(0),queued:eU(0),triggered:eU(0),metricsServiceUrl:eU(void 0)},tk={app:eU({name:ey,namespace:"com.kepixel.javascript",version:em,installType:"cdn"}),traits:eU(null),library:eU({name:ey,version:em,snippetVersion:globalThis.KepixelSnippetVersion}),userAgent:eU(null),device:eU(null),network:eU(null),os:eU({name:"",version:""}),locale:eU(null),screen:eU({density:0,width:0,height:0,innerWidth:0,innerHeight:0}),"ua-ch":eU(void 0),timezone:eU(void 0)},t$={configuredDestinations:eU([]),activeDestinations:eU([]),loadOnlyIntegrations:eU({}),failedDestinations:eU([]),loadIntegration:eU(!0),initializedDestinations:eU([]),clientDestinationsReady:eU(!1),integrationsConfig:eU({})},tI={toBeProcessedArray:eU([]),readyCallbacksArray:eU([])},tS={ready:eU(!1),loadedPlugins:eU([]),failedPlugins:eU([]),pluginsToLoadFromConfig:eU([]),activePlugins:eU([]),totalPluginsToLoad:eU(0)},tE={encryptionPluginName:eU(void 0),migrate:eU(!1),type:eU(void 0),cookie:eU(void 0),entries:eU({}),trulyAnonymousTracking:eU(!1)},tA={isEnabledServerSideCookies:eU(!1),dataServiceUrl:eU(void 0)},tw={eventsQueuePluginName:eU(void 0),deliveryEnabled:eU(!0)},tT={enabled:eU(!1),pageLifecycle:{enabled:eU(!1),pageViewId:eU(void 0),pageLoadedTimestamp:eU(void 0)}},tP={...d({capabilities:tp,consents:tm,context:tk,eventBuffer:tI,lifecycle:ty,loadOptions:td,metrics:tb,nativeDestinations:t$,plugins:tS,reporting:tv,session:th,source:tf,storage:tE,serverCookies:tA,dataPlaneEvents:tw,autoTrack:tT})};function tC(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var t_,tD,t9,tx,tO,tR,tM,tN={exports:{}},tL={exports:{}},tB=(t9||(t9=1,tN.exports=(tD||(tD=1,tL.exports=function(){function e(e){return!isNaN(parseFloat(e))&&isFinite(e)}function t(e){return e.charAt(0).toUpperCase()+e.substring(1)}function i(e){return function(){return this[e]}}var n=["isConstructor","isEval","isNative","isToplevel"],r=["columnNumber","lineNumber"],s=["fileName","functionName","source"],a=n.concat(r,s,["args"],["evalOrigin"]);function o(e){if(e)for(var i=0;i<a.length;i++)void 0!==e[a[i]]&&this["set"+t(a[i])](e[a[i]])}o.prototype={getArgs:function(){return this.args},setArgs:function(e){if("[object Array]"!==Object.prototype.toString.call(e))throw TypeError("Args must be an Array");this.args=e},getEvalOrigin:function(){return this.evalOrigin},setEvalOrigin:function(e){if(e instanceof o)this.evalOrigin=e;else{if(!(e instanceof Object))throw TypeError("Eval Origin must be an Object or StackFrame");this.evalOrigin=new o(e)}},toString:function(){var e=this.getFileName()||"",t=this.getLineNumber()||"",i=this.getColumnNumber()||"",n=this.getFunctionName()||"";return this.getIsEval()?e?"[eval] ("+e+":"+t+":"+i+")":"[eval]:"+t+":"+i:n?n+" ("+e+":"+t+":"+i+")":e+":"+t+":"+i}},o.fromString=function(e){var t=e.indexOf("("),i=e.lastIndexOf(")"),n=e.substring(0,t),r=e.substring(t+1,i).split(","),s=e.substring(i+1);if(0===s.indexOf("@"))var a=/@(.+?)(?::(\d+))?(?::(\d+))?$/.exec(s,""),l=a[1],u=a[2],c=a[3];return new o({functionName:n,args:r||void 0,fileName:l,lineNumber:u||void 0,columnNumber:c||void 0})};for(var l=0;l<n.length;l++)o.prototype["get"+t(n[l])]=i(n[l]),o.prototype["set"+t(n[l])]=function(e){return function(t){this[e]=Boolean(t)}}(n[l]);for(var u=0;u<r.length;u++)o.prototype["get"+t(r[u])]=i(r[u]),o.prototype["set"+t(r[u])]=function(t){return function(i){if(!e(i))throw TypeError(t+" must be a Number");this[t]=Number(i)}}(r[u]);for(var c=0;c<s.length;c++)o.prototype["get"+t(s[c])]=i(s[c]),o.prototype["set"+t(s[c])]=function(e){return function(t){this[e]=String(t)}}(s[c]);return o}()),tx=tL.exports,tO=/(^|@)\S+:\d+/,tR=/^\s*at .*(\S+:\d+|\(native\))/m,tM=/^(eval@)?(\[native code])?$/,{parse:function(e){if(void 0!==e.stacktrace||void 0!==e["opera#sourceloc"])return this.parseOpera(e);if(e.stack&&e.stack.match(tR))return this.parseV8OrIE(e);if(e.stack)return this.parseFFOrSafari(e);throw Error("Cannot parse given Error object")},extractLocation:function(e){if(-1===e.indexOf(":"))return[e];var t=/(.+?)(?::(\d+))?(?::(\d+))?$/.exec(e.replace(/[()]/g,""));return[t[1],t[2]||void 0,t[3]||void 0]},parseV8OrIE:function(e){return e.stack.split("\n").filter(function(e){return!!e.match(tR)},this).map(function(e){e.indexOf("(eval ")>-1&&(e=e.replace(/eval code/g,"eval").replace(/(\(eval at [^()]*)|(,.*$)/g,""));var t=e.replace(/^\s+/,"").replace(/\(eval code/g,"(").replace(/^.*?\s+/,""),i=t.match(/ (\(.+\)$)/);t=i?t.replace(i[0],""):t;var n=this.extractLocation(i?i[1]:t),r=i&&t||void 0,s=["eval","<anonymous>"].indexOf(n[0])>-1?void 0:n[0];return new tx({functionName:r,fileName:s,lineNumber:n[1],columnNumber:n[2],source:e})},this)},parseFFOrSafari:function(e){return e.stack.split("\n").filter(function(e){return!e.match(tM)},this).map(function(e){if(e.indexOf(" > eval")>-1&&(e=e.replace(/ line (\d+)(?: > eval line \d+)* > eval:\d+:\d+/g,":$1")),-1===e.indexOf("@")&&-1===e.indexOf(":"))return new tx({functionName:e});var t=/((.*".+"[^@]*)?[^@]*)(?:@)/,i=e.match(t),n=i&&i[1]?i[1]:void 0,r=this.extractLocation(e.replace(t,""));return new tx({functionName:n,fileName:r[0],lineNumber:r[1],columnNumber:r[2],source:e})},this)},parseOpera:function(e){return!e.stacktrace||e.message.indexOf("\n")>-1&&e.message.split("\n").length>e.stacktrace.split("\n").length?this.parseOpera9(e):e.stack?this.parseOpera11(e):this.parseOpera10(e)},parseOpera9:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)/i,i=e.message.split("\n"),n=[],r=2,s=i.length;r<s;r+=2){var a=t.exec(i[r]);a&&n.push(new tx({fileName:a[2],lineNumber:a[1],source:i[r]}))}return n},parseOpera10:function(e){for(var t=/Line (\d+).*script (?:in )?(\S+)(?:: In function (\S+))?$/i,i=e.stacktrace.split("\n"),n=[],r=0,s=i.length;r<s;r+=2){var a=t.exec(i[r]);a&&n.push(new tx({functionName:a[3]||void 0,fileName:a[2],lineNumber:a[1],source:i[r]}))}return n},parseOpera11:function(e){return e.stack.split("\n").filter(function(e){return!!e.match(tO)&&!e.match(/^Error created at/)},this).map(function(e){var t,i=e.split("@"),n=this.extractLocation(i.pop()),r=i.shift()||"",s=r.replace(/<anonymous function(: (\w+))?>/,"$2").replace(/\([^)]*\)/g,"")||void 0;r.match(/\(([^)]*)\)/)&&(t=r.replace(/^[^(]+\(([^)]*)\)$/,"$1"));var a=void 0===t||"[arguments not available]"===t?void 0:t.split(",");return new tx({functionName:s,args:a,fileName:n[0],lineNumber:n[1],columnNumber:n[2],source:e})},this)}})),tN.exports);let t8=tC(tB),tU="global code",tH=e=>m(e)?e:"";function tK(e,t,i,n){return{errorClass:tH(e),message:`${i}${tH(t)}`,type:"browserjs",stacktrace:n.reduce((e,t)=>{var i,n;let r,s=((r={file:(i=t).fileName,method:I(n=i.functionName)&&/^global code$/i.test(n)?tU:n,lineNumber:i.lineNumber,columnNumber:i.columnNumber}).lineNumber&&r.lineNumber>-1&&!r.file&&!r.method&&(r.file=tU),r);try{return"{}"===JSON.stringify(s)?e:e.concat(s)}catch{return e}},[])}}let tF=(e,t)=>{let i;return E(e)&&m(ep(e))?i=e:(t.warn(`${z}:: Ignoring a non-error: ${eu(e)}.`),i=void 0),i},tj=(e,t)=>{try{return JSON.parse(e||"")}catch(i){t(ev(i,"Failed to parse response data"))}},t0="The request failed",tG=[RegExp(`${t0}.*`),/A script with the id .* is already loaded\./],tV=[/Failed to fetch dynamically imported module: .*/,/Unable to load \(.*\) the script with the id .*/,/A timeout of \d+ ms occurred while trying to load the script with id .*/],tQ={headers:{Accept:"application/json","Content-Type":"application/json;charset=UTF-8"},method:"GET"},tz=(e,t,i)=>{let n=P(tQ,t||{});return i&&(n.headers=P(n.headers,{Authorization:i})),n.url=e,n},t1=(e,t=1e4,i)=>new Promise((n,r)=>{let s;if(!0===e.sendRawData)s=e.data;else if(s=eu(e.data,!1,[],i),b(s))return void r({error:Error("Failed to prepare data for the request."),undefined:void 0,options:e});let a=new XMLHttpRequest,o=t=>{r({error:Error(e7(t0,t,e.url)),xhr:a,options:e,..."timeout"===t?.type?{timedOut:!0}:{}})};a.ontimeout=o,a.onerror=o,a.onload=()=>{var t,i,s;a.status>=200&&a.status<400?n({response:a.responseText,xhr:a,options:e}):r({error:Error(`${t=t0} with status ${i=a.status} (${s=a.statusText}) for URL: ${e.url}. Response: ${a.responseText.trim()}`),xhr:a,options:e})},a.open(e.method,e.url,!0),!0===e.withCredentials&&(a.withCredentials=!0),a.timeout=t,Object.keys(e.headers).forEach(t=>{e.headers[t]&&a.setRequestHeader(t,e.headers[t])});try{a.send(s)}catch(l){r({error:ev(l,`${t0} for URL: ${e.url}`),xhr:a,options:e})}}),t4=new class{constructor(e){this.logger=e,this.onError=this.onError.bind(this)}init(e){this.errorHandler=e}async getData(e){let{url:t,options:i,timeout:n,isRawResponse:r}=e;try{let s=await t1(tz(t,i,this.basicAuthHeader),n,this.logger);return{data:r?s.response:tj(s.response,this.onError),details:s}}catch(a){return{data:void 0,details:a}}}getAsyncData(e){let{callback:t,url:i,options:n,timeout:r,isRawResponse:s}=e,a=!y(t);t1(tz(i,n,this.basicAuthHeader),r,this.logger).then(e=>{a||t(s?e.response:tj(e.response,this.onError),e)}).catch(e=>{a||t(void 0,e)})}onError(e,t){this.errorHandler?.onError({error:e,context:"HttpClient",groupingHash:t})}setAuthHeader(e,t=!1){var i,n;let r=t?e:(i=`${e}:`,globalThis.btoa(Array.from(n=(new TextEncoder).encode(i),e=>String.fromCodePoint(e)).join("")));this.basicAuthHeader=`Basic ${r}`}resetAuthHeader(){this.basicAuthHeader=void 0}}(eq),tq=["www.test-host.com","localhost","127.0.0.1","[::1]"],tW=["userId","userTraits","groupId","groupTraits","anonymousId","config","instance","eventBuffer","traits","authToken"],t2=e=>{tP.capabilities.isAdBlockerDetectionInProgress.value=!0;try{let t=new URL(tP.lifecycle.sourceConfigUrl.value),i=`${t.origin}${t.pathname}?view=ad`;e.getAsyncData({url:i,options:{method:"HEAD",headers:{"Content-Type":void 0}},isRawResponse:!0,callback(e,t){tP.capabilities.isAdBlockerDetectionInProgress.value=!1,tP.capabilities.isAdBlocked.value=void 0!==t?.error||t?.xhr?.responseURL!==i}})}catch(n){throw tP.capabilities.isAdBlockerDetectionInProgress.value=!1,n}},t3=()=>{let e=globalThis.location.hostname;return!e||e&&tq.includes(e)?"development":"production"},t6=e=>{let t=eu(e,!1,tW);return null!==t?JSON.parse(t):{}},tX=(e,t,i,n)=>({id:`${e.value?.id??i.writeKey.value}..${t.sessionInfo.value.id??"NA"}..${n.pageLifecycle.pageViewId.value??"NA"}`,name:e.value?.name??"NA"}),tJ=(e,t)=>({locale:e.value??"NA",userAgent:t.value??"NA",time:new Date}),tZ=(e,t)=>{let i={version:"1",message_id:er(),source:{name:"js",sdk_version:t.context.app.value.version,write_key:t.lifecycle.writeKey.value,install_type:t.context.app.value.installType},errors:e};return eu(i)},t7=new class{initialized=!1;constructor(e,t){this.httpClient=e,this.logger=t}init(){this.initialized||(this.attachErrorListeners(),this.initialized=!0)}attachErrorListeners(){globalThis.addEventListener("error",e=>{this.onError({error:e,context:z,errorType:eW.UNHANDLEDEXCEPTION})}),globalThis.addEventListener("unhandledrejection",e=>{this.onError({error:e,context:z,errorType:eW.UNHANDLEDREJECTION})}),document.addEventListener("securitypolicyviolation",e=>{let t=m(e.blockedURI)?e.blockedURI:"";"enforce"===e.disposition&&t.startsWith(tr)&&!tP.capabilities.cspBlockedURLs.value.includes(t)&&(tP.capabilities.cspBlockedURLs.value=[...tP.capabilities.cspBlockedURLs.value,t])})}async onError(e){try{var t,i,n;let{error:r,context:s,customMessage:a,groupingHash:o}=e,l=e.errorType??eW.HANDLEDEXCEPTION,u=((e,t)=>{switch(t){case eW.UNHANDLEDEXCEPTION:{let{error:i}=e;return i||e}case eW.UNHANDLEDREJECTION:return e.reason;case eW.HANDLEDEXCEPTION:default:return e}})(r,l),c=tF(u,this.logger);if(k(c))return;let g=((e,t)=>{try{let i=t8.parse(e);return tK(e.name,e.message,t,i)}catch{return tK(e.name,e.message,t,[])}})(c,`${s}:: ${a?`${a} - `:""}`),h=ep(c).includes(eh);if(!h&&!(e=>{let t=e.stacktrace[0]?.file;if(!t||"string"!=typeof t)return!1;let i=t.substring(t.lastIndexOf("/")+1),n=t.split("/");return n[n.length-2]===te||["kep"].some(e=>i.startsWith(e)&&i.endsWith(".js"))})(g)&&l!==eW.HANDLEDEXCEPTION)return;let p;if(tP.reporting.isErrorReportingEnabled.value&&await (t=g,i=tP,n=this.httpClient,p=t.message,new Promise(e=>{if(tV.some(e=>e.test(p))){let t=/https?:\/\/[^\s"'(),;<>[\]{}]+/.exec(p)?.[0];m(t)?t.startsWith(tr)?i.capabilities.cspBlockedURLs.value.includes(t)?e(!1):((e,t,i)=>{if(k(e.capabilities.isAdBlocked.value)){!1===e.capabilities.isAdBlockerDetectionInProgress.value&&t2(t);let n=ez(()=>{I(e.capabilities.isAdBlocked.value)&&(i(!1===e.capabilities.isAdBlocked.value),n())})}else i(!1===e.capabilities.isAdBlocked.value)})(i,n,e):e(!1):e(!0)}else e(!tG.some(e=>e.test(p)))}))){let v={severity:"error",unhandled:l!==eW.HANDLEDEXCEPTION,severityReason:{type:l}},f=((e,t,i,n)=>{let r;if("cdn"!==i.context.app.value.installType)return r;if(I(e)){if(m(e))r=e;else{let s=tF(e,n);r=I(s)?s.message:t}}else r=t;return r})(o,g.message,tP,this.logger),y=((e,t,i,n)=>{let{context:r,lifecycle:s,session:a,source:o,reporting:l,autoTrack:u}=i,{app:c,locale:g,userAgent:h,timezone:p,screen:v,library:f}=r;return{payloadVersion:"5",notifier:{name:"KePixelStack JavaScript SDK",version:c.value.version,url:"__REPOSITORY_URL__"},events:[{exceptions:[d(e)],severity:t.severity,unhandled:t.unhandled,severityReason:t.severityReason,app:{version:c.value.version,releaseStage:t3(),type:c.value.installType},device:tJ(g,h),request:{url:globalThis.location.href.split("?")[0],clientIp:"[NOT COLLECTED]"},breadcrumbs:d(l.breadcrumbs.value),context:e.message,groupingHash:n,metaData:{app:{snippetVersion:f.value.snippetVersion},device:{...v.value,timezone:p.value},...t6(i)},user:tX(o,a,s,u)}]}})(g,v,tP,f);this.httpClient.getAsyncData({url:tP.metrics.metricsServiceUrl.value,options:{method:"POST",data:tZ(y,tP),sendRawData:!0},isRawResponse:!0})}(l===eW.HANDLEDEXCEPTION||h)&&this.logger.error(g.message)}catch(b){this.logger.error(`${z}:: Failed to handle the error.`,b)}}leaveBreadcrumb(e){var t;try{tP.reporting.breadcrumbs.value=[...tP.reporting.breadcrumbs.value,(t=e,{type:"manual",name:t,timestamp:new Date,metaData:{}})]}catch(i){this.onError({error:i,context:z,customMessage:eX,groupingHash:eX})}}}(t4,eq),t5=new class{plugins=[];byName={};cache={};config={throws:!0};constructor(e,t={}){this.config={throws:!0,...t},this.logger=e}register(e,t){if(!e.name){let i=`${q}:: Plugin name is missing.`;if(this.config.throws)throw Error(i);return void this.logger.error(i,e)}if(this.byName[e.name]){let n=`${q}:: Plugin "${e.name}" already exists.`;if(this.config.throws)throw Error(n);return void this.logger.error(n)}this.cache={},this.plugins=this.plugins.slice();let r=this.plugins.length;this.plugins.forEach((t,i)=>{t.deps?.includes(e.name)&&(r=Math.min(r,i))}),this.plugins.splice(r,0,e),this.byName[e.name]=e,y(e.initialize)&&e.initialize(t)}unregister(e){let t=this.byName[e];if(!t){let i=`${q}:: Plugin "${e}" not found.`;if(this.config.throws)throw Error(i);return void this.logger.error(i)}let n=this.plugins.indexOf(t);if(-1!==n)this.cache={},delete this.byName[e],this.plugins=this.plugins.slice(),this.plugins.splice(n,1);else{let r=`${q}:: Plugin "${e}" not found in plugins but found in byName. This indicates a bug in the plugin engine. Please report this issue to the development team.`;if(this.config.throws)throw Error(r);this.logger.error(r)}}getPlugin(e){return this.byName[e]}getPlugins(e){let t=e??".";return this.cache[t]||(this.cache[t]=this.plugins.filter(e=>{if(e.deps?.some(e=>!this.byName[e])){let i=e.deps.filter(e=>!this.byName[e]);return this.logger.error(`${q}:: Plugin "${e.name}" could not be loaded because some of its dependencies "${i}" do not exist.`),!1}return"."===t||Boolean(A(e,t))})),this.cache[t]}processRawPlugins(e){e(this.plugins),this.cache={}}invoke(e,t=!0,...i){let n=e;if(!n)throw Error("Failed to invoke plugin because the extension point name is missing.");let r=n.startsWith("!"),s=this.config.throws??n.endsWith("!");if(!(n=n.replace(/(^!|!$)/g,"")))throw Error("Failed to invoke plugin because the extension point name is invalid.");let a=n.split(".");a.pop();let o=a.join(".");return(t?this.getPlugins(n):[this.getPlugins(n)[0]]).map(e=>{let t=A(e,n);if(!y(t)||r)return t;try{return t.apply(A(e,o),i)}catch(a){if(s)throw a;this.logger.error(`${q}:: Failed to invoke the "${n}" extension point of plugin "${e.name}".`,a)}return null})}invokeSingle(e,...t){return this.invoke(e,!1,...t)[0]}invokeMultiple(e,...t){return this.invoke(e,!0,...t)}}(eq,{throws:!0}),tY=e=>Boolean("cloud"!==e.config.connectionMode||!0===e.config.useNativeSDKToSend||!0===e.config.useNativeSDK),ie=e=>e.filter(tY),it=["BeaconQueue","CustomConsentManager","DeviceModeDestinations","DeviceModeTransformation","ExternalAnonymousId","GoogleLinker","IubendaConsentManager","KetchConsentManager","NativeDestinationQueue","OneTrustConsentManager","StorageEncryption","StorageEncryptionLegacy","StorageMigrator","XhrQueue"],ii=["Bugsnag","ErrorReporting"],ir={kepixelAnalyticsRemotePlugins:{url:()=>Promise.resolve(window.KePixelStackGlobals&&window.KePixelStackGlobals.app&&window.KePixelStackGlobals.app.pluginsCDNPath?`${window.KePixelStackGlobals.app.pluginsCDNPath}/kep-plugins.js`:"undefined//kep-plugins.js"),format:"esm",from:"vite"}};function is(e,t){if(!e?.default&&t){let i=Object.create(null);return i.default=e,i.__esModule=!0,i}return e}function ia(e,t){return(async function(e){let t=ir[e];return t.inited?t.lib:["esm","systemjs"].includes(t.format)?new Promise((e,i)=>{("function"==typeof t.url?t.url:()=>Promise.resolve(t.url))().then(n=>{import(n).then(i=>{if(!t.inited){let n=function e(t,i){let n=Object.assign(t,i);for(let r of Object.keys(n))"object"==typeof n[r]&&"object"==typeof i[r]&&(n[r]=e(n[r],i[r]));return n}({},(globalThis.__federation_shared__||{}).default||{});i.init(n),t.lib=i,t.lib.init(n),t.inited=!0}e(t.lib)}).catch(i)})}):void 0})(e).then(e=>e.get(t).then(e=>e()))}let io=e=>(e=>{let t={};return e.forEach(e=>{if(it.includes(e)){let i=(e=>{switch(e){case"BeaconQueue":return()=>ia("kepixelAnalyticsRemotePlugins","./BeaconQueue").then(e=>is(e,!0));case"CustomConsentManager":return()=>ia("kepixelAnalyticsRemotePlugins","./CustomConsentManager").then(e=>is(e,!0));case"DeviceModeDestinations":return()=>ia("kepixelAnalyticsRemotePlugins","./DeviceModeDestinations").then(e=>is(e,!0));case"DeviceModeTransformation":return()=>ia("kepixelAnalyticsRemotePlugins","./DeviceModeTransformation").then(e=>is(e,!0));case"ExternalAnonymousId":return()=>ia("kepixelAnalyticsRemotePlugins","./ExternalAnonymousId").then(e=>is(e,!0));case"GoogleLinker":return()=>ia("kepixelAnalyticsRemotePlugins","./GoogleLinker").then(e=>is(e,!0));case"KetchConsentManager":return()=>ia("kepixelAnalyticsRemotePlugins","./KetchConsentManager").then(e=>is(e,!0));case"IubendaConsentManager":return()=>ia("kepixelAnalyticsRemotePlugins","./IubendaConsentManager").then(e=>is(e,!0));case"NativeDestinationQueue":return()=>ia("kepixelAnalyticsRemotePlugins","./NativeDestinationQueue").then(e=>is(e,!0));case"OneTrustConsentManager":return()=>ia("kepixelAnalyticsRemotePlugins","./OneTrustConsentManager").then(e=>is(e,!0));case"StorageEncryption":return()=>ia("kepixelAnalyticsRemotePlugins","./StorageEncryption").then(e=>is(e,!0));case"StorageEncryptionLegacy":return()=>ia("kepixelAnalyticsRemotePlugins","./StorageEncryptionLegacy").then(e=>is(e,!0));case"StorageMigrator":return()=>ia("kepixelAnalyticsRemotePlugins","./StorageMigrator").then(e=>is(e,!0));case"XhrQueue":return()=>ia("kepixelAnalyticsRemotePlugins","./XhrQueue").then(e=>is(e,!0));default:return}})(e);i&&(t[e]=i)}}),t})?.(e)||{},il={};class iu{constructor(e,t,i){this.engine=e,this.errorHandler=t,this.logger=i,this.onError=this.onError.bind(this)}init(){tP.lifecycle.status.value="pluginsLoading",eA("pluginsCDNPath",tP.lifecycle.pluginsCDNPath.value),this.setActivePlugins(),this.registerLocalPlugins(),this.registerRemotePlugins(),this.attachEffects()}attachEffects(){ez(()=>{(0===tP.plugins.activePlugins.value.length||tP.plugins.loadedPlugins.value.length+tP.plugins.failedPlugins.value.length===tP.plugins.totalPluginsToLoad.value)&&e9(()=>{tP.plugins.ready.value=!0,tP.lifecycle.status.value="pluginsReady"})})}getPluginsToLoadBasedOnConfig(){let e=tP.plugins.pluginsToLoadFromConfig.value;return e?(e=e.filter(e=>!ii.includes(e)||(this.logger.warn(`${V}:: ${e} plugin is deprecated. Please exclude it from the load API options.`),!1)),[{configurationStatus:()=>I(tP.dataPlaneEvents.eventsQueuePluginName.value),configurationStatusStr:"Data plane events delivery is enabled",activePluginName:tP.dataPlaneEvents.eventsQueuePluginName.value,supportedPlugins:Object.values(tc),shouldAddMissingPlugins:!0},{configurationStatus:()=>ie(tP.nativeDestinations.configuredDestinations.value).length>0,configurationStatusStr:"Device mode destinations are connected to the source",supportedPlugins:["DeviceModeDestinations","NativeDestinationQueue"]},{configurationStatus:()=>ie(tP.nativeDestinations.configuredDestinations.value).some(e=>e.shouldApplyDeviceModeTransformation),configurationStatusStr:"Device mode transformations are enabled for at least one destination",supportedPlugins:["DeviceModeTransformation"]},{configurationStatus:()=>I(tP.consents.activeConsentManagerPluginName.value),configurationStatusStr:"Consent management is enabled",activePluginName:tP.consents.activeConsentManagerPluginName.value,supportedPlugins:Object.values(tl)},{configurationStatus:()=>I(tP.storage.encryptionPluginName.value),configurationStatusStr:"Storage encryption is enabled",activePluginName:tP.storage.encryptionPluginName.value,supportedPlugins:Object.values(tu)},{configurationStatus:()=>tP.storage.migrate.value,configurationStatusStr:"Storage migration is enabled",supportedPlugins:["StorageMigrator"]}].forEach(t=>{t.configurationStatus()?(e=e.filter(t.activePluginName?e=>!(e!==t.activePluginName&&t.supportedPlugins.includes(e)):e=>I(e)),this.addMissingPlugins(t,!1,e)):e=e.filter(void 0!==t.basePlugins?e=>!(t.basePlugins.includes(e)||t.supportedPlugins.includes(e)):e=>!t.supportedPlugins.includes(e))}),[...e]):[]}addMissingPlugins(e,t,i){var n,r,s,a;let o,l=e.shouldAddMissingPlugins||t,u=(o=e.activePluginName?[...e.basePlugins||[],e.activePluginName]:[...e.supportedPlugins]).filter(e=>!i.includes(e)),c,d;u.length>0&&(l&&i.push(...u),this.logger.warn((n=V,r=e.configurationStatusStr,s=u,a=l,d=`${n}:: ${r}, but${(c=1===s.length)?` '${s[0]}' plugin was`:` ['${s.join("', '")}'] plugins were`} not configured to load.`,a?`${d} So, ${c?"the plugin":"those plugins"} will be loaded automatically.`:`${d} Ignore if this was intentional. Otherwise, consider adding ${c?"it":"them"} to the 'plugins' load API option.`)))}setActivePlugins(){let e=this.getPluginsToLoadBasedOnConfig(),t=[...Object.keys(il),...it],i=[],n=[];e.forEach(e=>{t.includes(e)?i.push(e):n.push(e)}),n.length>0&&this.logger.warn(`${V}:: Ignoring unknown plugins: ${n.join(", ")}.`),e9(()=>{tP.plugins.totalPluginsToLoad.value=e.length,tP.plugins.activePlugins.value=i,tP.plugins.failedPlugins.value=n})}registerLocalPlugins(){Object.values(il).forEach(e=>{y(e)&&tP.plugins.activePlugins.value.includes(e().name)&&this.register([e()])})}registerRemotePlugins(){let e={...io(tP.plugins.activePlugins.value)};Promise.all(Object.keys(e).map(async t=>{await e[t]().then(e=>this.register([e.default()])).catch(e=>{tP.plugins.failedPlugins.value=[...tP.plugins.failedPlugins.value,t],this.onError(e,`Failed to load plugin "${t}"`,e)})})).catch(e=>{this.onError(e)})}invokeMultiple(e,...t){try{return this.engine.invokeMultiple(e,...t)}catch(i){return this.onError(i,e),[]}}invokeSingle(e,...t){try{return this.engine.invokeSingle(e,...t)}catch(i){return this.onError(i,e),null}}register(e){e.forEach(e=>{try{this.engine.register(e,tP)}catch(t){tP.plugins.failedPlugins.value=[...tP.plugins.failedPlugins.value,e.name],this.onError(t,`Failed to register plugin "${e.name}"`)}})}unregisterLocalPlugins(){Object.values(il).forEach(e=>{try{this.engine.unregister(e().name)}catch(t){this.onError(t,`Failed to unregister plugin "${e().name}"`)}})}onError(e,t,i){this.errorHandler.onError({error:e,context:V,customMessage:t,groupingHash:i})}}let ic="cookieStorage",id="localStorage",ig="sessionStorage",ih="memoryStorage",ip="none",iv={userId:"rl_user_id",userTraits:"rl_trait",anonymousId:"rl_anonymous_id",groupId:"rl_group_id",groupTraits:"rl_group_trait",initialReferrer:"rl_page_init_referrer",initialReferringDomain:"rl_page_init_referring_domain",sessionInfo:"rl_session",authToken:"rl_auth_token"},iy="clientDataInCookie",im="clientDataInLocalStorage",ib="clientDataInSessionStorage",ik=["userId","userTraits","anonymousId","groupId","groupTraits","initialReferrer","initialReferringDomain","sessionInfo","authToken"],i$={[ic]:iy,[id]:im,[ih]:"clientDataInMemory",[ig]:ib},iI=(e,t)=>{try{return encodeURIComponent(e)}catch(i){return void t?.error("Failed to encode the cookie data.",i)}},iS=e=>{try{return decodeURIComponent(e)}catch(t){return}},iE=()=>{var e;let t,i,n;return e=globalThis.document.cookie,i={},(n=e.split(/\s*;\s*/))[0]&&n.forEach(e=>{let n=(t=e.split("="))[0]?iS(t[0]):void 0;n&&(i[n]=t[1]?iS(t[1]):void 0)}),i},iA=(()=>{let e=[()=>globalThis.localStorage,()=>globalThis.sessionStorage];for(let t=0;t<e.length;t+=1)try{let i=e[t]();if(!i)continue;let n="__kepixel_storage_probe__";return i.setItem(n,"1"),i.removeItem(n),i}catch(r){}return null})(),iw=e=>{if(!iA)return null;try{let t=iA.getItem(e);if(!t)return null;let i=JSON.parse(t);if(i&&"object"==typeof i&&"value"in i){if(i.expiresAt&&Date.now()>i.expiresAt)return iA.removeItem(e),null;return i.value}return t}catch(n){try{return iA.getItem(e)||null}catch(r){return null}}},iT=function(e,t,i,n){switch(arguments.length){case 4:case 3:case 2:var r,s,a,o;let l,u;return r=e,s=t,a=i,o=n,l={...a||{}},u=`${iI(r,o)}=${iI(s,o)}`,void(b(s)&&(l.maxage=-1),l.maxage&&(l.expires=new Date(+new Date+l.maxage)),l.path&&(u+=`; path=${l.path}`),l.domain&&(u+=`; domain=${l.domain}`),l.expires&&(u+=`; expires=${l.expires.toUTCString()}`),l.samesite&&(u+=`; samesite=${l.samesite}`),l.secure&&(u+="; secure"),globalThis.document.cookie=u);case 1:{if(!e)return iE();let c=iw(e);if(null!=c)return c;return iE()[e]}default:return iE()}},iP=()=>{let e=`.${(e=>{let t=(e=>{var t;let i,n=("function"!=typeof globalThis.URL?(t=e,(i=document.createElement("a")).href=t,i.hostname):new URL(e).hostname)?.split(".")??[],r=n[n.length-1],s=[];if(4===n.length&&r&&r===parseInt(r,10).toString())return s;if(n.length<=1)return n[0]&&-1!==n[0].indexOf("localhost")?["localhost"]:s;for(let a=n.length-2;a>=0;a-=1)s.push(n.slice(a).join("."));return s})(globalThis.location.href);for(let i=0;i<t.length;i+=1){let n=t[i],r="__tld__",s={domain:`${-1!==n.indexOf("localhost")?"":"."}${n}`};if(iT(r,1,s),iT(r))return iT(r,null,s),n}return""})()}`;return{maxage:31536e6,path:"/",domain:e&&"."!==e?e:void 0,samesite:"Lax",enabled:!0}},iC=new class{isEnabled=!0;length=0;data={};constructor(e){this.options={enabled:!0},this.logger=e}configure(e){return this.options=P(this.options,e??{}),this.isEnabled=Boolean(this.options.enabled),this.options}setItem(e,t){return this.data[e]=t,this.length=Object.keys(this.data).length,t}getItem(e){return e in this.data?this.data[e]:null}removeItem(e){return e in this.data&&delete this.data[e],this.length=Object.keys(this.data).length,null}clear(){this.data={},this.length=0}key(e){return this.keys()[e]??null}keys(){return Object.keys(this.data)}}(eq);var i_,iD={exports:{}},i9=(i_||(i_=1,iD.exports=function(){function e(e){return e=JSON.stringify(e),!!/^\{[\s\S]*\}$/.test(e)}function t(e){if("string"==typeof e)try{return JSON.parse(e)}catch(t){return e}}function i(e){return"[object Function]"===({}).toString.call(e)}var n=function(e){var t="_Is_Incognit";try{e||(e=window.localStorage),e.setItem(t,"yes"),e.removeItem(t)}catch(i){var n={_data:{},setItem:function(e,t){return n._data[e]=String(t)},getItem:function(e){return n._data.hasOwnProperty(e)?n._data[e]:void 0},removeItem:function(e){return delete n._data[e]},clear:function(){return n._data={}}};e=n}finally{"yes"===e.getItem(t)&&e.removeItem(t)}return e}();function r(){if(!(this instanceof r))return new r}r.prototype={set:function(t,i){var r;if(t&&!e(t))n.setItem(t,void 0===(r=i)||"function"==typeof r?r+"":JSON.stringify(r));else if(e(t))for(var s in t)this.set(s,t[s]);return this},get:function(e){if(void 0===e){var i={};return this.forEach(function(e,t){return i[e]=t}),i}if("?"===e.charAt(0))return this.has(e.substr(1));var r=arguments;if(r.length>1){for(var s={},a=0,o=r.length;a<o;a++){var l=t(n.getItem(r[a]));this.has(r[a])&&(s[r[a]]=l)}return s}return t(n.getItem(e))},clear:function(){return n.clear(),this},remove:function(e){var t=this.get(e);return n.removeItem(e),t},has:function(e){return({}).hasOwnProperty.call(this.get(),e)},keys:function(){var e=[];return this.forEach(function(t){e.push(t)}),e},forEach:function(e){for(var t=0,i=n.length;t<i;t++){var r=n.key(t);e(r,this.get(r))}return this},search:function(e){for(var t=this.keys(),i={},n=0,r=t.length;n<r;n++)t[n].indexOf(e)>-1&&(i[t[n]]=this.get(t[n]));return i},len:function(){return n.length}};var s=null;function a(t,n){var o,l=arguments,u=null;if(s||(s=r()),0===l.length)return s.get();if(1===l.length){if("string"==typeof t)return s.get(t);if(e(t))return s.set(t)}if(2===l.length&&"string"==typeof t){if(!n)return s.remove(t);if(n&&"string"==typeof n)return s.set(t,n);n&&i(n)&&(u=null,u=n(t,s.get(t)),a.set(t,u))}if(2===l.length&&(o=t,"[object Array]"===Object.prototype.toString.call(o))&&i(n))for(var c=0,d=t.length;c<d;c++)u=n(t[c],s.get(t[c])),a.set(t[c],u);return a}for(var o in r.prototype)a[o]=r.prototype[o];return a}()),iD.exports);let ix=tC(i9),iO=()=>!$(globalThis.navigator.userAgentData),iR={URL:()=>!y(globalThis.URL)||!y(globalThis.URLSearchParams),Promise:()=>!y(globalThis.Promise),"Number.isNaN":()=>!y(globalThis.Number.isNaN),"Number.isInteger":()=>!y(globalThis.Number.isInteger),"Array.from":()=>!y(globalThis.Array.from),"Array.prototype.find":()=>!y(globalThis.Array.prototype.find),"Array.prototype.includes":()=>!y(globalThis.Array.prototype.includes),"String.prototype.endsWith":()=>!y(globalThis.String.prototype.endsWith),"String.prototype.startsWith":()=>!y(globalThis.String.prototype.startsWith),"String.prototype.includes":()=>!y(globalThis.String.prototype.includes),"String.prototype.replaceAll":()=>!y(globalThis.String.prototype.replaceAll),"String.fromCodePoint":()=>!y(globalThis.String.fromCodePoint),"Object.entries":()=>!y(globalThis.Object.entries),"Object.values":()=>!y(globalThis.Object.values),"Object.assign":()=>!y(globalThis.Object.assign),"Object.fromEntries":()=>!y(globalThis.Object.fromEntries),"Element.prototype.dataset"(){let e;return(e=globalThis.document.createElement("div")).setAttribute("data-a-b","c"),!e.dataset||"c"!==e.dataset.aB},TextEncoder:()=>!y(globalThis.TextEncoder)||!y(globalThis.TextDecoder),requestAnimationFrame:()=>!y(globalThis.requestAnimationFrame)||!y(globalThis.cancelAnimationFrame),CustomEvent:()=>!y(globalThis.CustomEvent),"navigator.sendBeacon":()=>!y(globalThis.navigator.sendBeacon),ArrayBuffer:()=>!y(globalThis.Uint8Array),Set:()=>!y(globalThis.Set),atob:()=>!y(globalThis.atob)},iM=()=>({width:globalThis.screen.width,height:globalThis.screen.height,density:globalThis.devicePixelRatio,innerWidth:globalThis.innerWidth,innerHeight:globalThis.innerHeight}),iN=e=>{let t=["QuotaExceededError","NS_ERROR_DOM_QUOTA_REACHED"].includes(e.name)||[22,1014].includes(e.code);return e instanceof DOMException&&t},iL=(e=id,t,i)=>{let n,r,s,a=`${F}:: The "${e}" storage type is `,o="unavailable",l=!0;try{switch(e){case ih:return!0;case ic:n=t,r="test_kepixel_cookie";break;case id:n=t??globalThis.localStorage,r="test_kepixel_ls";break;case ig:n=t??globalThis.sessionStorage,r="test_kepixel_ss";break;default:return!1}if(n&&(n.setItem(r,"true"),n.getItem(r)))return n.removeItem(r),!0;l=!1}catch(u){l=!1,s=u,iN(u)&&(o="full")}return l||i?.warn(`${a}${o}.`,s),!1},iB=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e){this.options={enabled:!0},this.logger=e}configure(e){return this.options=P(this.options,e??{}),this.isSupportAvailable=iL(id),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){ix.set(e,t),this.length=ix.len()}getItem(e){let t=ix.get(e);return k(t)?null:t}removeItem(e){ix.remove(e),this.length=ix.len()}clear(){ix.clear(),this.length=0}key(e){return this.keys()[e]??null}keys(){return ix.keys()}}(eq),i8=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e){this.options={enabled:!0},this.logger=e}configure(e){return this.options=P(this.options,e??{}),this.isSupportAvailable=iL(ig),this.isSupportAvailable&&(this.store=globalThis.sessionStorage),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){this.store&&(this.store.setItem(e,t),this.length=this.store.length)}getItem(e){if(!this.store)return null;let t=this.store.getItem(e);return k(t)?null:t}removeItem(e){this.store&&(this.store.removeItem(e),this.length=this.store.length)}clear(){this.store?.clear(),this.length=0}key(e){return this.store?.key(e)??null}keys(){let e=[];if(!this.store)return e;for(let t=0;t<this.store.length;t+=1){let i=this.store.key(t);null!==i&&e.push(i)}return e}}(eq),iU=new class{isSupportAvailable=!0;isEnabled=!0;length=0;constructor(e){this.logger=e}configure(e){return this.options||(this.options=iP()),this.options=P(this.options,e??{}),this.options.sameDomainCookiesOnly&&delete this.options.domain,this.isSupportAvailable=iL(ic,this),this.isEnabled=Boolean(this.options.enabled&&this.isSupportAvailable),this.options}setItem(e,t){return iT(e,t,this.options,this.logger),this.length=Object.keys(iT()).length,!0}getItem(e){let t=iT(e);return k(t)?null:t}removeItem(e){let t=this.setItem(e,null);return this.length=Object.keys(iT()).length,t}clear(){}key(e){return this.keys()[e]??null}keys(){return Object.keys(iT())}}(eq),iH=e=>{switch(e){case id:return iB;case ig:return i8;case ih:return iC;case ic:return iU;default:return iC}};class iK{constructor(e,t,i){this.id=e.id,this.name=e.name,this.isEncrypted=e.isEncrypted??!1,this.validKeys=e.validKeys??{},this.engine=t,this.noKeyValidation=0===Object.keys(this.validKeys).length,this.noCompoundKey=e.noCompoundKey,this.originalEngine=this.engine,this.errorHandler=e.errorHandler,this.logger=e.logger,this.pluginsManager=i}createValidKey(e){let t,{name:i,id:n,validKeys:r,noKeyValidation:s,noCompoundKey:a}=this;return s?a?e:[i,n,e].join("."):(Object.values(r).forEach(r=>{r===e&&(t=a?e:[i,n,e].join("."))}),t)}swapQueueStoreToInMemoryEngine(){let{name:e,id:t,validKeys:i,noCompoundKey:n}=this,r=iH(ih);Object.keys(i).forEach(s=>{let a=this.get(i[s]),o=n?s:[e,t,s].join(".");r.setItem(o,a),this.remove(s)}),this.engine=r}set(e,t){let i=this.createValidKey(e);if(i)try{this.engine.setItem(i,this.encrypt(eu(t,!1,[],this.logger)))}catch(n){if(iN(n))this.logger.warn(`Store ${this.id}:: The storage is either full or unavailable, so the data will not be persisted. Switching to in-memory storage.`),this.swapQueueStoreToInMemoryEngine(),this.set(e,t);else{let r=`Failed to save the value for "${e}" to storage`;this.onError(n,r,r)}}}get(e){let t,i=this.createValidKey(e);try{return i?(t=this.decrypt(this.engine.getItem(i)),$(t)||""===t?null:JSON.parse(t)):null}catch(n){let r=`Failed to retrieve or parse data for "${e}" from storage`;return this.onError(n,r,r),null}}remove(e){let t=this.createValidKey(e);t&&this.engine.removeItem(t)}getOriginalEngine(){return this.originalEngine}decrypt(e){return $(e)?null:this.crypto(e,"decrypt")}encrypt(e){return this.crypto(e,"encrypt")}crypto(e,t){if(!this.isEncrypted||!e||"string"!=typeof e||""===e.replace(/^\s+|\s+$/gm,""))return e;let i=`storage.${t}`,n=this.pluginsManager?this.pluginsManager.invokeSingle(i,e):e;return void 0===n?e:n??""}onError(e,t,i){this.errorHandler.onError({error:e,context:`Store ${this.id}`,customMessage:t,groupingHash:i})}}class iF{stores={};isInitialized=!1;constructor(e,t,i){this.errorHandler=t,this.logger=i,this.pluginsManager=e}init(){if(this.isInitialized)return;let e=tP.loadOptions.value,t={cookieStorageOptions:{samesite:e.sameSiteCookie,secure:e.secureCookie,domain:e.setCookieDomain,sameDomainCookiesOnly:e.sameDomainCookiesOnly},localStorageOptions:{},inMemoryStorageOptions:{},sessionStorageOptions:{}};((e={},t={},i={},n={})=>{var r,s,a,o;let l;o=e,l=iU.configure(o),tP.storage.cookie.value={maxage:l.maxage,path:l.path,domain:l.domain,samesite:l.samesite,expires:l.expires,secure:l.secure},r=t,iB.configure(r),s=i,iC.configure(s),a=n,i8.configure(a)})(_(P(t.cookieStorageOptions??{},tP.storage.cookie?.value??{})),_(t.localStorageOptions),_(t.inMemoryStorageOptions),_(t.sessionStorageOptions)),this.initClientDataStores(),this.isInitialized=!0}initClientDataStores(){this.initializeStorageState(),[ih,id,ic,ig].forEach(e=>{iH(e)?.isEnabled&&this.setStore({id:i$[e],name:i$[e],isEncrypted:!0,noCompoundKey:!0,type:e,errorHandler:this.errorHandler,logger:this.logger})})}initializeStorageState(){let e=tP.storage.type.value,t=tP.loadOptions.value.storage?.entries,i=tP.consents.postConsent.value.storage;(I(i?.type)||I(i?.entries))&&(e=i?.type,t=i?.entries);let n=!0,r={};ik.forEach(i=>{let s=t?.[i]?.type,a=((e,t)=>{let i;if(e.consents.preConsent.value.enabled)switch(e.consents.preConsent.value.storage?.strategy){case"none":i=ip;break;case"session":"sessionInfo"!==t&&(i=ip);break;case"anonymousId":"anonymousId"!==t&&(i=ip)}return i})(tP,i)??s??e??e3,o=this.getResolvedStorageTypeForEntry(a,i);o!==ip&&(n=!1),r={...r,[i]:{type:o,key:iv[i]}}}),e9(()=>{tP.storage.type.value=e,tP.storage.entries.value=r,tP.storage.trulyAnonymousTracking.value=n})}getResolvedStorageTypeForEntry(e,t){let i=e;switch(e){case id:iH(id)?.isEnabled||(i=ih);break;case ig:iH(ig)?.isEnabled||(i=ih);break;case ih:case ip:break;default:i=iH(ic)?.isEnabled?ic:iH(id)?.isEnabled?id:iH(ig)?.isEnabled?ig:ih}return i!==e&&this.logger.warn(`StoreManager:: The storage type "${e}" is not available for entry "${t}". The SDK will initialize the entry with "${i}" storage type instead.`),i}setStore(e){let t=iH(e.type);return this.stores[e.id]=new iK(e,t,this.pluginsManager),this.stores[e.id]}getStore(e){return this.stores[e]}}let ij=e=>{let t,{host:i,protocol:n}=new URL(e),r=i.split(".");return{topDomain:t=r.length>2?`${r[r.length-2]}.${r[r.length-1]}`:i,protocol:n}},i0=e=>e?.endsWith("/")?i0(e.substring(0,e.length-1)):e,iG=e=>{try{return new URL(e).host}catch(t){return null}},iV=e=>iG(e)??"",iQ=e=>{let t={},i="rl_campaign";try{let n=new URL(e),r="utm_";if(n.searchParams.forEach((e,i)=>{if(i.startsWith(r)){let n=i.substring(r.length);"campaign"===n&&(n="name"),t[n]=e}}),Object.keys(t).length>0)try{globalThis.sessionStorage?.setItem(i,JSON.stringify(t))}catch(s){}else try{let a=globalThis.sessionStorage?.getItem(i);a&&(t=JSON.parse(a))}catch(o){}}catch(l){try{let u=globalThis.sessionStorage?.getItem(i);u&&(t=JSON.parse(u))}catch(c){}}return t},iz=e=>{if(!m(e))return!1;try{return y(globalThis.URL)&&new URL(e),ti.test(e)}catch(t){return!1}},i1="none",i4="immediate",iq=e=>C(e)||Array.isArray(e),iW=(e,t)=>{let i,n,r=[],s=[],a=!1,o=!0===e?.enabled;C(e)&&o&&({provider:n,consentManagerPluginName:i}=((e,t)=>{let{provider:i}=e,n=i?tl[i]:void 0;return i&&!n&&(t.error(`${j}:: The consent manager "${i}" is not supported. Please choose one of the following supported consent managers: "${Object.keys(tl)}".`),i=void 0),{provider:i,consentManagerPluginName:n}})(e,t),iq(e.allowedConsentIds)&&(r=e.allowedConsentIds,a=!0),iq(e.deniedConsentIds)&&(s=e.deniedConsentIds,a=!0));let l={allowedConsentIds:r,deniedConsentIds:s};return o=o&&Boolean(i),{provider:n,consentManagerPluginName:i,initialized:a,enabled:o,consentsData:l}},i2=e=>{let t,{useServerSideCookies:i,dataServiceEndpoint:n,storage:r,setCookieDomain:s,sameDomainCookiesOnly:a}=tP.loadOptions.value,o=r?.cookie,l=!1;if(i){var u;l=i;let c=o.domain??s,d=I(c)&&!(e=>{let{topDomain:t}=ij(window.location.href);return t===e})(R(c))||a,g=(u=n??"rsaRequest",`${d?window.location.origin:(e=>{let{topDomain:t,protocol:i}=ij(e);return`${i}//${t}`})(window.location.href)}/${u.startsWith("/")?u.substring(1):u}`);if(iz(g)){t=i0(g);let h=iG(window.location.href),p=iG(g);h!==p&&(o={...o,samesite:"None",secure:!0}),!a&&d&&p!==R(c)&&(l=!1,e.warn(`${j}:: The provided cookie domain (${c}) does not match the current webpage's domain (${p}). Hence, the cookies will be set client-side.`))}else l=!1}return{sscEnabled:l,cookieOptions:o,finalDataServiceUrl:t}},i3=(e,t,i,n,r,s,a)=>{let o;if(s){if(!iz(s))return a.error(`${j}:: The base URL "${s}" for ${e} is not valid.`),null;o=i0(s)}else if(o=i,"cdn"===tP.context.app.value.installType){let l=(()=>{let e=document.querySelector("script[data-kep-write-key]");if(e&&e.dataset.rsaWriteKey===tP.lifecycle.writeKey.value)return e.src;let t=document.getElementsByTagName("script"),i=/(?:^|\/)kep(\.min)?\.js$/;for(let n of t){let r=n.getAttribute("src");if(r&&i.test(r))return r}})();l&&(o=l.split("/").slice(0,-1).concat(t).join("/"))}return r&&(o=o.replace(RegExp(`/v3/${tn}/${t}$`),`/${n}/${tn}/${t}`)),o};class i6{constructor(e,t,i){this.errorHandler=t,this.logger=i,this.httpClient=e,this.onError=this.onError.bind(this),this.processConfig=this.processConfig.bind(this)}attachEffects(){ez(()=>{this.logger.setMinLogLevel(tP.lifecycle.logLevel.value)})}init(){let e,{logLevel:t,configUrl:i,lockIntegrationsVersion:n,lockPluginsVersion:r,destSDKBaseURL:s,pluginsSDKBaseURL:a,integrations:o}=tP.loadOptions.value,l=i3("integrations",te,ts,em,n,s,this.logger);b(l)||null!==(e=i3("plugins",tt,ta,em,r,a,this.logger))&&(this.attachEffects(),tP.lifecycle.activeDataplaneUrl.value=i0(tP.lifecycle.dataPlaneUrl.value),(e=>{var t;let{storage:i}=tP.loadOptions.value,n=i?.type;I(n)&&("string"!=typeof(t=n)||!e2.includes(t))&&(e.warn(`${j}:: The storage type "${n}" is not supported. Please choose one of the following supported types: "${e2}". The default type "${e3}" will be used instead.`),n=e3);let r=i?.encryption?.version,s=r&&tu[r];!k(r)&&k(s)?(e.warn(`${j}:: The storage encryption version "${r}" is not supported. Please choose one of the following supported versions: "${Object.keys(tu)}". The default version "v3" will be used instead.`),r="v3"):k(r)&&(r="v3");let a=i?.migrate,o=a&&"v3"===r;!0===a&&o!==a&&e.warn(`${j}:: The storage data migration has been disabled because the configured storage encryption version (${r}) is not the latest (v3). To enable storage data migration, please update the storage encryption version to the latest version.`);let{sscEnabled:l,finalDataServiceUrl:u,cookieOptions:c}=i2(e);e9(()=>{tP.storage.type.value=n,tP.storage.cookie.value=c,tP.serverCookies.isEnabledServerSideCookies.value=l,tP.serverCookies.dataServiceUrl.value=u,tP.storage.encryptionPluginName.value=tu[r],tP.storage.migrate.value=o})})(this.logger),(e=>{let{provider:t,consentManagerPluginName:i,initialized:n,enabled:r,consentsData:s}=iW(tP.loadOptions.value.consentManagement,e),a=tP.loadOptions.value.preConsent,o=a?.storage?.strategy??i1;I(o)&&!["none","session","anonymousId"].includes(o)&&(o=i1,e.warn(`${j}:: The pre-consent storage strategy "${a?.storage?.strategy}" is not supported. Please choose one of the following supported strategies: "none, session, anonymousId". The default strategy "${i1}" will be used instead.`));let l=a?.events?.delivery??i4;I(l)&&!["immediate","buffer"].includes(l)&&(l=i4,e.warn(`${j}:: The pre-consent events delivery type "${a?.events?.delivery}" is not supported. Please choose one of the following supported types: "immediate, buffer". The default type "${i4}" will be used instead.`)),e9(()=>{tP.consents.activeConsentManagerPluginName.value=i,tP.consents.initialized.value=n,tP.consents.enabled.value=r,tP.consents.data.value=s,tP.consents.provider.value=t,tP.consents.preConsent.value={enabled:!0===tP.loadOptions.value.preConsent?.enabled&&!1===n&&!0===r,storage:{strategy:o},events:{delivery:l}}})})(this.logger),(e=>{if(tP.dataPlaneEvents.deliveryEnabled.value){let t="XhrQueue",i=t;tP.loadOptions.value.useBeacon&&(tP.capabilities.isBeaconAvailable.value?i="BeaconQueue":(i=t,e.warn(`${j}:: The Beacon API is not supported by your browser. The events will be sent using XHR instead.`))),e9(()=>{tP.dataPlaneEvents.eventsQueuePluginName.value=i})}})(this.logger),e9(()=>{tP.lifecycle.integrationsCDNPath.value=l,tP.lifecycle.pluginsCDNPath.value=e,t&&(tP.lifecycle.logLevel.value=t),tP.lifecycle.sourceConfigUrl.value=((e,t,i,n,r)=>{let s=new URLSearchParams({p:"cdn",v:em,build:tn,writeKey:t,lockIntegrationsVersion:i.toString(),lockPluginsVersion:n.toString()}),a=to,o=s,l="/sourceConfig/",u="";if(iz(e)){let c=new URL(e);i0(c.pathname).endsWith("/sourceConfig")||(c.pathname=`${i0(c.pathname)}/sourceConfig/`),c.pathname=c.pathname.replace(/\/{2,}/g,"/"),s.forEach((e,t)=>{null===c.searchParams.get(t)&&c.searchParams.set(t,e)}),a=c.origin,l=c.pathname,o=c.searchParams,u=c.hash}else r.warn(`${j}:: The provided source config URL "${e}" is invalid. Using the default source config URL instead.`);return`${a}${l}?${o}${u}`})(i,tP.lifecycle.writeKey.value,n,r,this.logger),tP.metrics.metricsServiceUrl.value=`${tP.lifecycle.activeDataplaneUrl.value}/rsaMetrics`,tP.nativeDestinations.loadOnlyIntegrations.value=o}),this.getConfig())}onError(e,t,i){this.errorHandler.onError({error:e,context:j,customMessage:t,groupingHash:i})}processConfig(e,t){var i,n;if(!I(e))return void(I(t)?this.onError(t.error,eJ):this.onError(Error(eJ)));let r;try{r=m(e)?JSON.parse(e):e}catch(s){return void this.onError(s,e6)}if(!(w(i=r)&&w(i.source)&&!$(i.source.id)&&w(i.source.config)&&Array.isArray(i.source.destinations)))return void this.onError(Error(e6));if(!1===r.source.enabled)return void this.logger.error("The source is disabled. Please enable the source in the dashboard to send events.");n=r,tP.reporting.isErrorReportingEnabled.value=!0===n.source.config?.statsCollection?.errors?.enabled&&!window.chrome?.runtime?.id,tP.reporting.isMetricsReportingEnabled.value=!0===n.source.config?.statsCollection?.metrics?.enabled;let a=r.source.destinations.length>0?r.source.destinations.map(e=>({id:e.id,displayName:e.destinationDefinition.displayName,enabled:e.enabled,config:e.config,shouldApplyDeviceModeTransformation:e.shouldApplyDeviceModeTransformation??!1,propagateEventsUntransformedOnError:e.propagateEventsUntransformedOnError??!1,userFriendlyId:`${e.destinationDefinition.displayName.replaceAll(" ","-")}___${e.id}`})):[];e9(()=>{var e;let t,i;tP.source.value={config:r.source.config,name:r.source.name,id:r.source.id,workspaceId:r.source.workspaceId},tP.nativeDestinations.configuredDestinations.value=a,tP.plugins.pluginsToLoadFromConfig.value=tP.loadOptions.value.plugins??[],e=r,i=tP.consents.resolutionStrategy.value,w(e.consentManagementMetadata)&&(tP.consents.provider.value&&(i=e.consentManagementMetadata.providers.find(e=>e.provider===tP.consents.provider.value)?.resolutionStrategy??tP.consents.resolutionStrategy.value),t=e.consentManagementMetadata),"custom"===tP.consents.provider.value&&(i=void 0),e9(()=>{tP.consents.metadata.value=d(t),tP.consents.resolutionStrategy.value=i}),tP.lifecycle.status.value="configured"})}getConfig(){let e=tP.loadOptions.value.getSourceConfig;if(e){if(!y(e))return void this.logger.error(`${j}:: The "getSourceConfig" load API option must be a function that returns valid source configuration data.`);let t=e();t instanceof Promise?t.then(e=>this.processConfig(e)).catch(e=>{this.onError(e,"SourceConfig")}):this.processConfig(t)}else this.httpClient.getAsyncData({url:tP.lifecycle.sourceConfigUrl.value,options:{headers:{"Content-Type":void 0}},callback:this.processConfig})}}let iX=()=>document?.referrer||"$direct",iJ=()=>{let e=(()=>{let e=document.getElementsByTagName("link"),t="";for(let i=0;e[i];i+=1){let n=e[i];if("canonical"===n.getAttribute("rel")&&!t){t=n.getAttribute("href")??"";break}}return t})(),t=globalThis.location.pathname,{href:i}=globalThis.location,n=i,{search:r}=globalThis.location;if(e)try{let s=new URL(e);n=""===s.search?e+r:e,t=s.pathname}catch(a){}let o=(e=>{let t=e;try{let i=new URL(e);t=i.origin+i.pathname+i.search}catch(n){}return t})(n),{title:l}=document,u=iX();return{path:t,referrer:u,referring_domain:iV(u),search:r,title:l,url:o,tab_url:i}},iZ=`https://polyfill-fastly.io/v3/polyfill.min.js?version=3.111.0&features=${Object.keys(iR).join("%2C")}`,i7="kepixelstackPolyfill",i5=["integrations","anonymousId","originalTimestamp"],iY=["library","consentManagement","userAgent","ua-ch","screen"],ne=["id","anonymous_id","user_id","sent_at","timestamp","received_at","original_timestamp","event","event_text","channel","context_ip","context_request_ip","context_passed_ip","group_id","previous_id"],nt=e=>"number"==typeof e&&!Number.isNaN(e),ni=e=>nt(e)&&e>=0&&Number.isInteger(e),nn=e=>{let{cutOff:t}=e,i=Date.now();return Boolean(t?.enabled&&t.expiresAt&&i>t.expiresAt)},nr=e=>Boolean(!e.expiresAt||Date.now()>e.expiresAt)||nn(e),ns=(e,t)=>!!(e&&ni(e)&&e.toString().length>=10)||(t.warn(`${Q}:: The provided session ID (${e}) is either invalid, not a positive integer, or not at least "10" digits long. A new session ID will be auto-generated instead.`),!1),na=e=>Boolean(e===ic||e===id||e===ig||e===ih),no=()=>er(),nl=e=>{let t=iJ(),i={};return Object.keys(t).forEach(n=>{i[n]=e?.[n]||t[n]}),i.initial_referrer=e?.initial_referrer||tP.session.initialReferrer.value,i.initial_referring_domain=e?.initial_referring_domain||tP.session.initialReferringDomain.value,i},nu=(e,t,i)=>{w(e)&&Object.keys(e).forEach(e=>{(ne.includes(e)||ne.includes(e.toLowerCase()))&&i.warn(`${G}:: The "${e}" property defined under "${t}" is a reserved keyword. Please choose a different property name to avoid conflicts with reserved keywords (${ne}).`)})},nc=(e,t,i)=>{var n,r,s,a,o;let l;w(t)&&(n=e,(r=t).anonymousId&&m(r.anonymousId)&&(n.anonymousId=r.anonymousId),C(r.integrations)&&(n.integrations=r.integrations),r.originalTimestamp&&m(r.originalTimestamp)&&(n.originalTimestamp=r.originalTimestamp),e.context=(s=e.context,a=t,o=i,l=s,Object.keys(a).forEach(e=>{if(!i5.includes(e)&&!iY.includes(e)){if("context"!==e)l=P(l,{[e]:a[e]});else if(!k(a[e])&&w(a[e])){let t={};Object.keys(a[e]).forEach(i=>{iY.includes(i)||(t[i]=a[e][i])}),l=P(l,{...t})}else o.warn(`${G}:: Please make sure that the "context" property in the event API's "options" argument is a valid object literal with key-value pairs.`)}}),l))},nd=(e,t,i,n)=>{var r;let s={channel:"web",context:{traits:d(tP.session.userTraits.value),sessionId:tP.session.sessionInfo.value.id||void 0,sessionStart:tP.session.sessionInfo.value.sessionStart||void 0,...tP.consents.enabled.value&&{consentManagement:{deniedConsentIds:d(tP.consents.data.value.deniedConsentIds),allowedConsentIds:d(tP.consents.data.value.allowedConsentIds),provider:tP.consents.provider.value,resolutionStrategy:tP.consents.resolutionStrategy.value}},"ua-ch":tP.context["ua-ch"].value,app:tP.context.app.value,library:tP.context.library.value,userAgent:tP.context.userAgent.value,os:tP.context.os.value,locale:tP.context.locale.value,screen:tP.context.screen.value,campaign:iQ(globalThis.location.href),page:nl(i),timezone:tP.context.timezone.value,facebook_click_id:iT("_fbc"),facebook_browser_id:iT("_fbp"),pinterest_click_id:iT("_epik"),tiktok_click_id:iT("ttclid"),tiktok_ttp:iT("_ttp"),snapchat_click_id:iT("_scclid"),snapchat_scid:iT("_scid"),microsoft_click_id:iT("_uetmsclkid"),linkedin_click_id:iT("li_fat_id"),twitter_click_id:(e=>{if(!e)return null;try{let t=decodeURI(e),i=JSON.parse(t);return i&&i.twclid?i.twclid:e}catch{return e}})(iT("_twclid")),google_click_id:iT("_gcl_aw")||iT("_gcl_dc")||iT("FPGCLAW")||iT("FPGCLDC"),snapchat_advertiser_cookie_1:iT("snapchat_advertiser_cookie_1"),...tP.autoTrack.enabled.value&&{autoTrack:{...tP.autoTrack.pageLifecycle.enabled.value&&{page:{pageViewId:tP.autoTrack.pageLifecycle.pageViewId.value}}}}},originalTimestamp:es(new Date),messageId:er(),userId:e.userId||tP.session.userId.value};na(tP.storage.entries.value.anonymousId?.type)?s.anonymousId=tP.session.anonymousId.value:s.anonymousId=no(),tP.storage.trulyAnonymousTracking.value&&(s.context.trulyAnonymousTracking=!0),"identify"===e.type&&(s.context.traits=tP.storage.entries.value.userTraits?.type!==ip?d(tP.session.userTraits.value):e.context.traits),"group"===e.type&&((e.groupId||tP.session.groupId.value)&&(s.groupId=e.groupId||tP.session.groupId.value),(e.traits||tP.session.groupTraits.value)&&(s.traits=tP.storage.entries.value.groupTraits?.type!==ip?d(tP.session.groupTraits.value):e.traits));let a,o=P(e,s);return void 0===o.event&&(o.event=null),void 0===o.properties&&(o.properties=null),nc(o,t,n),((e,t)=>{let{properties:i,traits:n,context:r}=e,{traits:s}=r;nu(i,"properties",t),nu(n,"traits",t),nu(s,"context.traits",t)})(o,n),o.integrations=(r=o.integrations,a=tP.loadOptions.value.useGlobalIntegrationsConfigInEvents?tP.consents.postConsent.value.integrations??tP.nativeDestinations.loadOnlyIntegrations.value:r||eY,d(a)),o};class ng{constructor(e,t,i,n){this.eventRepository=e,this.userSessionManager=t,this.errorHandler=i,this.logger=n,this.eventFactory=new class{constructor(e){this.logger=e}generatePageEvent(e,t,i,n){var r,s;let a=i??{},o,l,u;return a=(r=a,o=(s=n)?.page||{},l=r,Object.keys(u=iJ()).forEach(e=>{k(l[e])&&(l[e]=o[e]||u[e])}),k(l.initial_referrer)&&(l.initial_referrer=o.initial_referrer||tP.session.initialReferrer.value),k(l.initial_referring_domain)&&(l.initial_referring_domain=o.initial_referring_domain||tP.session.initialReferringDomain.value),l),nd({properties:a,name:t,category:e,type:"page"},n,a,this.logger)}generateTrackEvent(e,t,i){return nd({properties:t,event:e,type:"track"},i,void 0,this.logger)}generateIdentifyEvent(e,t,i){return nd({userId:e,type:"identify",context:{traits:t}},i,void 0,this.logger)}generateAliasEvent(e,t,i){let n=nd({previousId:t,type:"alias"},i,void 0,this.logger);return n.userId=e??n.userId,n}generateGroupEvent(e,t,i){let n={type:"group"};return e&&(n.groupId=e),t&&(n.traits=t),nd(n,i,void 0,this.logger)}create(e){let t;switch(e.type){case"page":t=this.generatePageEvent(e.category,e.name,e.properties,e.options);break;case"track":t=this.generateTrackEvent(e.name,e.properties,e.options);break;case"identify":t=this.generateIdentifyEvent(e.userId,e.traits,e.options);break;case"alias":t=this.generateAliasEvent(e.to,e.from,e.options);break;default:t=this.generateGroupEvent(e.groupId,e.traits,e.options)}return t}}(this.logger)}init(){this.eventRepository.init()}resume(){this.eventRepository.resume()}addEvent(e){this.userSessionManager.refreshSession();let t=this.eventFactory.create(e);this.eventRepository.enqueue(t,e.callback)}}class nh{constructor(e,t,i,n,r){this.storeManager=t,this.pluginsManager=e,this.logger=r,this.errorHandler=n,this.httpClient=i,this.onError=this.onError.bind(this),this.serverSideCookieDebounceFuncs={}}init(){this.syncStorageDataToState(),this.registerEffects()}syncStorageDataToState(){this.migrateStorageIfNeeded(),this.migrateDataFromPreviousStorage(),this.setUserId(this.getUserId()),this.setUserTraits(this.getUserTraits()),this.setGroupId(this.getGroupId()),this.setGroupTraits(this.getGroupTraits());let e,{externalAnonymousIdCookieName:t,anonymousIdOptions:i}=tP.loadOptions.value;S(t)&&"string"==typeof t&&(e=this.getExternalAnonymousIdByCookieName(t)),this.setAnonymousId(e??this.getAnonymousId(i)),this.setAuthToken(this.getAuthToken()),this.setInitialReferrerInfo(),this.configureSessionTracking()}configureSessionTracking(){let e;if(this.isPersistenceEnabledForStorageEntry("sessionInfo")){let t=this.getConfiguredSessionTrackingInfo(),i=this.getSessionInfo()??tg.sessionInfo;(e={autoTrack:t.autoTrack&&!0!==i.manualTrack,timeout:t.timeout,manualTrack:i.manualTrack,expiresAt:i.expiresAt,id:i.id,sessionStart:i.sessionStart}).autoTrack||!0===e.manualTrack?!0===t.cutOff?.enabled&&(e.cutOff={enabled:!0,duration:t.cutOff.duration,expiresAt:i.cutOff?.expiresAt}):e=tg.sessionInfo}else e=tg.sessionInfo;tP.session.sessionInfo.value=e,tP.session.sessionInfo.value.autoTrack&&this.startOrRenewAutoTracking(tP.session.sessionInfo.value)}setInitialReferrerInfo(){let e=this.getInitialReferrer(),t=this.getInitialReferringDomain(),i=iX(),n=iV(i);if(!e||!t||"$direct"===e&&i&&"$direct"!==i){this.setInitialReferrer(i),this.setInitialReferringDomain(n);return}this.setInitialReferrer(e),this.setInitialReferringDomain(t)}isPersistenceEnabledForStorageEntry(e){return na(tP.storage.entries.value[e]?.type)}migrateDataFromPreviousStorage(){let e=tP.storage.entries.value,t=[ic,id,ig];Object.keys(e).forEach(i=>{let n=i,r=e[n]?.type,s=this.storeManager?.getStore(i$[r]);s&&t.forEach(e=>{let t=this.storeManager?.getStore(i$[e]);if(t&&e!==r){var i;let a=t.get(iv[n]);S(i=a)&&""!==i&&s.set(iv[n],a),t.remove(iv[n])}})})}migrateStorageIfNeeded(e,t){if(!tP.storage.migrate.value)return;let i=e??[];0===i.length&&[iy,im,ib].forEach(e=>{let t=this.storeManager?.getStore(e);t&&i.push(t)}),(t??Object.keys(iv)).forEach(e=>{let t=iv[e];i.forEach(e=>{let i=this.pluginsManager?.invokeSingle("storage.migrate",t,e.engine,this.errorHandler,this.logger);$(i)||e.set(t,i)})})}getConfiguredSessionTrackingInfo(){let e,t=!1!==tP.loadOptions.value.sessions.autoTrack;if(!t)return{autoTrack:t};let i=tP.loadOptions.value.sessions?.timeout;return ni(i)?e=i:(this.logger.warn(`${Q}:: The session timeout value "${i}" is not a number. The default timeout of 1800000 ms will be used instead.`),e=18e5),0===e&&(this.logger.warn(`${Q}:: The session timeout value is 0, which disables the automatic session tracking feature. If you want to enable session tracking, please provide a positive integer value for the timeout.`),t=!1),e>0&&e<1e4&&this.logger.warn(`${Q}:: The session timeout value ${e} ms is less than the recommended minimum of 10000 ms. Please consider increasing the timeout value to ensure optimal performance and reliability.`),{timeout:e,autoTrack:t,cutOff:this.getCutOffInfo(e)}}getCutOffInfo(e){let t,i=tP.loadOptions.value.sessions.cutOff,n=!1;return!0===i.enabled&&(t=i.duration,n=!0,ni(t)?t<e&&(this.logger.warn(`${Q}:: The session cut off duration value "${t}" ms is less than the session timeout value "${e}" ms. The cut off functionality will be disabled.`),n=!1):(this.logger.warn(`${Q}:: The session cut off duration value "${t}" is not a number. The default cut off duration of 43200000 ms will be used instead.`),t=432e5)),{enabled:n,duration:t}}onError(e,t,i){this.errorHandler.onError({error:e,context:Q,customMessage:t,groupingHash:i})}getEncryptedCookieData(e,t){let i=[];return e.forEach(e=>{let n=t?.encrypt(eu(e.value,!1,[],this.logger));S(n)&&i.push({name:e.name,value:n})}),i}makeRequestToSetCookie(e,t){this.httpClient?.getAsyncData({url:tP.serverCookies.dataServiceUrl.value,options:{method:"POST",data:eu({reqType:"setCookies",workspaceId:tP.source.value?.workspaceId,data:{options:{maxAge:tP.storage.cookie.value?.maxage,path:tP.storage.cookie.value?.path,domain:tP.storage.cookie.value?.domain,sameSite:tP.storage.cookie.value?.samesite,secure:tP.storage.cookie.value?.secure,expires:tP.storage.cookie.value?.expires},cookies:e}}),sendRawData:!0,withCredentials:!0},isRawResponse:!0,callback:t})}setServerSideCookies(e,t,i){try{let n=this.getEncryptedCookieData(e,i);n.length>0&&this.makeRequestToSetCookie(n,(n,r)=>{200===r?.xhr?.status?e.forEach(e=>{let n=i?.get(e.name),r=eu(e.value,!1,[]);eu(n,!1,[])!==r&&(this.logger.error(`The server failed to set the ${e.name} cookie. As a fallback, the cookies will be set client side.`),t&&t(e.name,e.value))}):(this.logger.error(`The server responded with status ${r?.xhr?.status} while setting the cookies. As a fallback, the cookies will be set client side.`),e.forEach(e=>{t&&t(e.name,e.value)}))})}catch(r){this.onError(r,e5,e5),e.forEach(e=>{t&&t(e.name,e.value)})}}syncValueToStorage(e,t){let i=tP.storage.entries.value,n=i[e]?.type;if(na(n)){let r=this.storeManager?.getStore(i$[n]),s=i[e]?.key;t&&(m(t)||C(t))?tP.serverCookies.isEnabledServerSideCookies.value&&n===ic?(this.serverSideCookieDebounceFuncs[e]&&globalThis.clearTimeout(this.serverSideCookieDebounceFuncs[e]),this.serverSideCookieDebounceFuncs[e]=globalThis.setTimeout(()=>{this.setServerSideCookies([{name:s,value:t}],(e,t)=>{r?.set(e,t)},r)},10)):r?.set(s,t):r?.remove(s)}}registerEffects(){ik.forEach(e=>{ez(()=>{this.syncValueToStorage(e,tP.session[e].value)})})}setAnonymousId(e,t){let i=e;(m(e)&&i||(i=void 0),this.isPersistenceEnabledForStorageEntry("anonymousId"))?(!i&&t&&(i=this.pluginsManager?.invokeSingle("userSession.anonymousIdGoogleLinker",t)),i=i||no()):i=tg.anonymousId,tP.session.anonymousId.value=i}getAnonymousId(e){if(na(tP.storage.entries.value.anonymousId?.type)){let t=tP.session.anonymousId.value;t&&t!==tg.anonymousId||(t=this.getEntryValue("anonymousId")),!t&&e&&(t=this.pluginsManager?.invokeSingle("storage.getAnonymousId",iH,e)),tP.session.anonymousId.value=t||no()}return tP.session.anonymousId.value}getEntryValue(e){let t=tP.storage.entries.value,i=t[e]?.type;if(na(i)){let n=this.storeManager?.getStore(i$[i]);this.migrateStorageIfNeeded([n],[e]);let r=t[e]?.key;return n?.get(r)??null}return null}getExternalAnonymousIdByCookieName(e){let t=iH(ic);return t?.isEnabled?t.getItem(e)??null:null}getUserId(){return this.getEntryValue("userId")}getUserTraits(){return this.getEntryValue("userTraits")}getGroupId(){return this.getEntryValue("groupId")}getGroupTraits(){return this.getEntryValue("groupTraits")}getInitialReferrer(){return this.getEntryValue("initialReferrer")}getInitialReferringDomain(){return this.getEntryValue("initialReferringDomain")}getSessionInfo(){return this.getEntryValue("sessionInfo")}getAuthToken(){return this.getEntryValue("authToken")}getSessionId(){let e=this.getSessionInfo()??tg.sessionInfo;return e.autoTrack&&!nr(e)||e.manualTrack?e.id??null:null}refreshSession(){let e=this.getSessionInfo()??tg.sessionInfo;(e.autoTrack||e.manualTrack)&&(e.autoTrack&&(this.startOrRenewAutoTracking(e),e=tP.session.sessionInfo.value),void 0===e.sessionStart?e={...e,sessionStart:!0}:e.sessionStart&&(e={...e,sessionStart:!1})),tP.session.sessionInfo.value=e,"readyExecuted"!==tP.lifecycle.status.value&&this.syncValueToStorage("sessionInfo",e)}reset(e,t){let{session:i}=tP,{manualTrack:n,autoTrack:r,timeout:s,cutOff:a}=i.sessionInfo.value;e9(()=>{if(i.userId.value=tg.userId,i.userTraits.value=tg.userTraits,i.groupId.value=tg.groupId,i.groupTraits.value=tg.groupTraits,i.authToken.value=tg.authToken,!0===e&&this.setAnonymousId(),!t){if(r){let o={...tg.sessionInfo,timeout:s};a&&(o.cutOff={enabled:a.enabled,duration:a.duration}),i.sessionInfo.value=o,this.startOrRenewAutoTracking(i.sessionInfo.value)}else n&&this.startManualTrackingInternal()}})}setUserId(e){tP.session.userId.value=this.isPersistenceEnabledForStorageEntry("userId")&&e?e:tg.userId}setUserTraits(e){tP.session.userTraits.value=this.isPersistenceEnabledForStorageEntry("userTraits")&&w(e)?P(tP.session.userTraits.value??tg.userTraits,e):tg.userTraits}setGroupId(e){tP.session.groupId.value=this.isPersistenceEnabledForStorageEntry("groupId")&&e?e:tg.groupId}setGroupTraits(e){tP.session.groupTraits.value=this.isPersistenceEnabledForStorageEntry("groupTraits")&&w(e)?P(tP.session.groupTraits.value??tg.groupTraits,e):tg.groupTraits}setInitialReferrer(e){tP.session.initialReferrer.value=this.isPersistenceEnabledForStorageEntry("initialReferrer")&&e?e:tg.initialReferrer}setInitialReferringDomain(e){tP.session.initialReferringDomain.value=this.isPersistenceEnabledForStorageEntry("initialReferringDomain")&&e?e:tg.initialReferringDomain}startOrRenewAutoTracking(e){let t=e;if(nr(e))t=(e=>{let{timeout:t,cutOff:i}=e,n=Date.now();return{id:n,expiresAt:n+t,timeout:t,autoTrack:!0,...i&&{cutOff:i}}})(e);else{let i=Date.now(),n=e.timeout;t.expiresAt=i+n}if(nn(t)&&(t.cutOff.expiresAt=void 0),t.cutOff){let r=(e=>{if(e?.enabled)return e.expiresAt??(ni(e.duration)?Date.now()+e.duration:void 0)})(t.cutOff);t.cutOff.expiresAt=r}tP.session.sessionInfo.value=t}start(e){var t;tP.session.sessionInfo.value={id:ns(t=e,this.logger)?t:Date.now(),sessionStart:void 0,manualTrack:!0}}startManualTrackingInternal(){this.start(Date.now())}end(){tP.session.sessionInfo.value=tg.sessionInfo}setAuthToken(e){tP.session.authToken.value=this.isPersistenceEnabledForStorageEntry("authToken")&&e?e:tg.authToken}}let np=["BeaconQueue","CustomConsentManager","DeviceModeDestinations","DeviceModeTransformation","ExternalAnonymousId","GoogleLinker","IubendaConsentManager","KetchConsentManager","NativeDestinationQueue","OneTrustConsentManager","StorageEncryption","StorageEncryptionLegacy","StorageMigrator","XhrQueue"],nv="dataplaneEventsQueue",nf="destinationsEventsQueue",ny=(e,t,i,n)=>{if(I(e)){if(y(e))try{e(...t)}catch(r){n.error(`${i}:: The callback threw an exception`,r)}else n.error(eZ(i))}};class nm{constructor(e,t,i,n,r){this.pluginsManager=e,this.errorHandler=n,this.httpClient=i,this.logger=r,this.storeManager=t}init(){var e;this.dataplaneEventsQueue=this.pluginsManager.invokeSingle(`${nv}.init`,tP,this.httpClient,this.storeManager,this.errorHandler,this.logger),this.dmtEventsQueue=this.pluginsManager.invokeSingle("transformEvent.init",tP,this.pluginsManager,this.httpClient,this.storeManager,this.errorHandler,this.logger),this.destinationsEventsQueue=this.pluginsManager.invokeSingle(`${nf}.init`,tP,this.pluginsManager,this.storeManager,this.dmtEventsQueue,this.errorHandler,this.logger),ez(()=>{!0===tP.nativeDestinations.clientDestinationsReady.value&&(this.destinationsEventsQueue?.start(),this.dmtEventsQueue?.start())});let t,i=(e=tP).consents.preConsent.value.enabled&&"buffer"===e.consents.preConsent.value.events?.delivery;ez(()=>{let e=!0===tP.loadOptions.value.bufferDataPlaneEventsUntilReady&&!1===tP.nativeDestinations.clientDestinationsReady.value;!1!==tP.nativeDestinations.activeDestinations.value.some(e=>{var t;return Boolean("hybrid"===(t=e).config.connectionMode||!0===t.config.useNativeSDKToSend)})&&!1!==e||i||!0===this.dataplaneEventsQueue?.scheduleTimeoutActive||(globalThis.clearTimeout(t),this.dataplaneEventsQueue?.start())}),!0===tP.loadOptions.value.bufferDataPlaneEventsUntilReady&&(t=globalThis.setTimeout(()=>{!0!==this.dataplaneEventsQueue?.scheduleTimeoutActive&&this.dataplaneEventsQueue?.start()},tP.loadOptions.value.dataPlaneEventsBufferTimeout))}resume(){!0!==this.dataplaneEventsQueue?.scheduleTimeoutActive&&(tP.consents.postConsent.value.discardPreConsentEvents&&(this.dataplaneEventsQueue?.clear(),this.destinationsEventsQueue?.clear()),this.dataplaneEventsQueue?.start())}enqueue(e,t){var i,n,r,s;let a,o,l,u=(i=e,n=tP,a=d(i),o=n.nativeDestinations.integrationsConfig.value,l=(r=i.integrations,s=o,Object.keys(r).filter(e=>!0!==r[e]||!s[e]).reduce((e,t)=>{let i=d(e);return i[t]=r[t],i},{})),a.integrations=P(o,l),a);this.pluginsManager.invokeSingle(`${nv}.enqueue`,tP,this.dataplaneEventsQueue,u,this.errorHandler,this.logger);let c=d(e);this.pluginsManager.invokeSingle(`${nf}.enqueue`,tP,this.destinationsEventsQueue,c,this.errorHandler,this.logger),ny(t,[u],`${e.type.charAt(0).toUpperCase()}${e.type.slice(1)}API`,this.logger)}}let nb=e=>{let t=new CustomEvent(e,{detail:{analyticsInstance:globalThis.kepixelAnalytics},bubbles:!0,cancelable:!0,composed:!0});globalThis.document.dispatchEvent(t)};class nk{constructor(){this.preloadBuffer=new class{constructor(){this.items=[]}enqueue(e){this.items.push(e)}dequeue(){return 0===this.items.length?null:this.items.shift()}isEmpty(){return 0===this.items.length}size(){return this.items.length}clear(){this.items=[]}},this.initialized=!1,this.errorHandler=t7,this.logger=eq,this.externalSrcLoader=new eC(this.logger),this.httpClient=t4,this.httpClient.init(this.errorHandler),this.capabilitiesManager=new class{constructor(e,t,i){this.httpClient=e,this.errorHandler=t,this.logger=i,this.externalSrcLoader=new eC(this.logger),this.onError=this.onError.bind(this),this.onReady=this.onReady.bind(this)}init(){this.prepareBrowserCapabilities(),this.attachWindowListeners()}detectBrowserCapabilities(){e9(()=>{let e;tP.capabilities.storage.isCookieStorageAvailable.value=iL(ic,iH(ic),this.logger),tP.capabilities.storage.isLocalStorageAvailable.value=iL(id,void 0,this.logger),tP.capabilities.storage.isSessionStorageAvailable.value=iL(ig,void 0,this.logger),tP.capabilities.isBeaconAvailable.value=!$(globalThis.navigator.sendBeacon)&&y(globalThis.navigator.sendBeacon),tP.capabilities.isUaCHAvailable.value=iO(),tP.capabilities.isCryptoAvailable.value=!$(globalThis.crypto)&&y(globalThis.crypto.getRandomValues),tP.capabilities.isIE11.value=Boolean(globalThis.navigator.userAgent.match(/Trident.*rv:11\./)),tP.capabilities.isOnline.value=globalThis.navigator.onLine,tP.context.userAgent.value=(()=>{if(k(globalThis.navigator))return null;let{userAgent:e}=globalThis.navigator,{brave:t}=globalThis.navigator;if(t&&Object.getPrototypeOf(t).isBrave){let i=e.match(/(chrome)\/([\w.]+)/i);i&&(e=`${e} Brave/${i[2]}`)}return e})(),tP.context.locale.value=k(globalThis.navigator)?null:globalThis.navigator.language??globalThis.navigator.browserLanguage,tP.context.screen.value=iM(),tP.context.timezone.value=(e=/([A-Z]+[+-]\d+)/.exec((new Date).toString()))?.[1]?e[1]:"NA",iO()&&((e,t="none")=>{"none"===t&&e(void 0),"default"===t&&e(navigator.userAgentData),"full"===t&&navigator.userAgentData?.getHighEntropyValues(["architecture","bitness","brands","mobile","model","platform","platformVersion","uaFullVersion","fullVersionList","wow64"]).then(t=>{e(t)}).catch(()=>{e()})})(e=>{tP.context["ua-ch"].value=e},tP.loadOptions.value.uaChTrackLevel)}),ez(()=>{!0===tP.loadOptions.value.sendAdblockPage&&void 0!==tP.lifecycle.sourceConfigUrl.value&&t2(this.httpClient)})}prepareBrowserCapabilities(){tP.capabilities.isLegacyDOM.value=(()=>{let e=Object.keys(iR),t=!1;for(let i=0;i<e.length;i++){let n=iR[e[i]];if(y(n)&&n()){t=!0;break}}return t})();let e=tP.loadOptions.value.polyfillURL,t=iZ;if(S(e)&&(iz(e)?t=e:this.logger.warn(`${F}:: The provided polyfill URL "${e}" is invalid. The default polyfill URL will be used instead.`)),tP.loadOptions.value.polyfillIfRequired&&tP.capabilities.isLegacyDOM.value&&iz(t)){let i=t!==tP.loadOptions.value.polyfillURL;if(i){let n=`KE_polyfillCallback_${tP.lifecycle.writeKey.value}`,r=()=>{this.onReady(),delete globalThis[n]};globalThis[n]=r,t=`${t}&callback=${n}`}this.externalSrcLoader.loadJSFile({url:t,id:i7,async:!0,timeout:1e4,callback:e=>{e?i||this.onReady():this.onError(Error(`Failed to load the polyfill script with ID "${i7}" from URL ${t}.`))}})}else this.onReady()}attachWindowListeners(){globalThis.addEventListener("offline",()=>{tP.capabilities.isOnline.value=!1}),globalThis.addEventListener("online",()=>{tP.capabilities.isOnline.value=!0}),globalThis.addEventListener("resize",function(e,t,i=250){let n;return(...r)=>{globalThis.clearTimeout(n),n=globalThis.setTimeout(()=>{e.apply(t,r)},i)}}(()=>{tP.context.screen.value=iM()},this))}onReady(){this.detectBrowserCapabilities(),tP.lifecycle.status.value="browserCapabilitiesReady"}onError(e,t){this.errorHandler.onError({error:e,context:F,groupingHash:t})}}(this.httpClient,this.errorHandler,this.logger)}load(e,t,i={}){var n;tP.lifecycle.status.value||(m(n=e)&&n.trim().length>0?iz(t)?(e9(()=>{var n,r;let s;tP.lifecycle.writeKey.value=d(e),tP.lifecycle.dataPlaneUrl.value=d(t),tP.loadOptions.value=(n=tP.loadOptions.value,s=d(r=i),m(s.setCookieDomain)||(s.setCookieDomain=void 0),["Strict","Lax","None"].includes(s.sameSiteCookie)||(s.sameSiteCookie=void 0),s.secureCookie=O(s.secureCookie,n.secureCookie),s.sameDomainCookiesOnly=O(s.sameDomainCookiesOnly,n.sameDomainCookiesOnly),["none","default","full"].includes(s.uaChTrackLevel)||(s.uaChTrackLevel=void 0),s.integrations=x(s.integrations),Array.isArray(s.plugins)||(s.plugins=np),s.useGlobalIntegrationsConfigInEvents=O(s.useGlobalIntegrationsConfigInEvents,n.useGlobalIntegrationsConfigInEvents),s.bufferDataPlaneEventsUntilReady=O(s.bufferDataPlaneEventsUntilReady,n.bufferDataPlaneEventsUntilReady),s.sendAdblockPage=O(s.sendAdblockPage,n.sendAdblockPage),s.useServerSideCookies=O(s.useServerSideCookies,n.useServerSideCookies),m(s.dataServiceEndpoint)||(s.dataServiceEndpoint=void 0),s.sendAdblockPageOptions=x(s.sendAdblockPageOptions),s.loadIntegration=O(s.loadIntegration,n.loadIntegration),C(s.storage)?(s.storage.migrate=O(s.storage.migrate,n.storage?.migrate),s.storage.cookie=x(s.storage.cookie),s.storage.encryption=x(s.storage.encryption),s.storage=D(s.storage)):s.storage=void 0,s.destinationsQueueOptions=x(s.destinationsQueueOptions),s.queueOptions=x(s.queueOptions),s.lockIntegrationsVersion=O(s.lockIntegrationsVersion,n.lockIntegrationsVersion),s.lockPluginsVersion=O(s.lockPluginsVersion,n.lockPluginsVersion),nt(s.dataPlaneEventsBufferTimeout)||(s.dataPlaneEventsBufferTimeout=void 0),s.beaconQueueOptions=x(s.beaconQueueOptions),s.preConsent=x(s.preConsent),s.sourceConfigurationOverride=x(s.sourceConfigurationOverride),P(n,D(s))),tP.lifecycle.status.value="mounted"}),this.logger.setMinLogLevel(tP.loadOptions.value.logLevel??e4),eA("state",tP,e),this.startLifecycle()):this.logger.error(`${X}:: The data plane URL "${t}" is invalid. It must be a valid URL string. Please check that the data plane URL is correct and try again.`):this.logger.error(`${X}:: The write key "${e}" is invalid. It must be a non-empty string. Please check that the write key is correct and try again.`))}startLifecycle(){ez(()=>{try{switch(tP.lifecycle.status.value){case"mounted":this.onMounted();break;case"browserCapabilitiesReady":this.onBrowserCapabilitiesReady();break;case"configured":this.onConfigured();break;case"pluginsLoading":case"destinationsLoading":case"readyExecuted":default:break;case"pluginsReady":this.onPluginsReady();break;case"initialized":this.onInitialized();break;case"loaded":this.onLoaded();break;case"destinationsReady":this.onDestinationsReady();break;case"ready":this.onReady()}}catch(e){let t="Failed to load the SDK";this.errorHandler.onError({error:e,context:X,customMessage:t,groupingHash:t})}})}onBrowserCapabilitiesReady(){var e;let t;e=this,((e=[])=>{let t=new URLSearchParams(globalThis.location.search);t.get(eS)&&e.unshift(["track",t.get(eS),eT(t,"ajs_prop_")]),t.get(eI)&&e.unshift(["identify",t.get(eI),eT(t,"ajs_trait_")]),t.get(e$)&&e.unshift(["setAnonymousId",t.get(e$)])})(t=ew(ek)||[]),t.length>0&&(e.enqueuePreloadBufferEvents(t),eA(ek,[])),this.prepareInternalServices(),this.loadConfig()}onLoaded(){this.processBufferedEvents(),!0===tP.consents.preConsent.value.enabled?tP.lifecycle.status.value="ready":this.loadDestinations()}onMounted(){this.capabilitiesManager.init()}enqueuePreloadBufferEvents(e){Array.isArray(e)&&e.forEach(e=>this.preloadBuffer.enqueue(d(e)))}processDataInPreloadBuffer(){for(;this.preloadBuffer.size()>0;){let e=this.preloadBuffer.dequeue();e&&eP([...e],this)}}prepareInternalServices(){this.pluginsManager=new iu(t5,this.errorHandler,this.logger),this.storeManager=new iF(this.pluginsManager,this.errorHandler,this.logger),this.configManager=new i6(this.httpClient,this.errorHandler,this.logger),this.userSessionManager=new nh(this.pluginsManager,this.storeManager,this.httpClient,this.errorHandler,this.logger),this.eventRepository=new nm(this.pluginsManager,this.storeManager,this.httpClient,this.errorHandler,this.logger),this.eventManager=new ng(this.eventRepository,this.userSessionManager,this.errorHandler,this.logger)}loadConfig(){tP.lifecycle.writeKey.value&&this.httpClient.setAuthHeader(tP.lifecycle.writeKey.value),this.configManager?.init()}onPluginsReady(){this.storeManager?.init(),this.userSessionManager?.init(),tP.consents.enabled.value&&!tP.consents.initialized.value&&(this.pluginsManager?.invokeSingle("consentManager.init",tP,this.logger),!1===tP.consents.preConsent.value.enabled&&this.pluginsManager?.invokeSingle("consentManager.updateConsentsInfo",tP,this.storeManager,this.logger)),this.eventManager?.init(),tP.lifecycle.status.value="initialized"}onConfigured(){this.pluginsManager?.init()}onInitialized(){this.processDataInPreloadBuffer(),ny(tP.loadOptions.value.onLoaded,[globalThis.kepixelAnalytics],"LoadAPI",this.logger),e9(()=>{tP.lifecycle.loaded.value=!0,tP.lifecycle.status.value="loaded"}),this.initialized=!0,nb("RSA_Initialised")}onReady(){tP.lifecycle.status.value="readyExecuted",tP.eventBuffer.readyCallbacksArray.value.forEach(e=>{ny(e,[],W,this.logger)}),nb("RSA_Ready")}processBufferedEvents(){let e=tP.eventBuffer.toBeProcessedArray.value;for(;e.length>0;){let t=e.shift();if(tP.eventBuffer.toBeProcessedArray.value=e,t){let i=t[0];y(this[i])&&this[i](...t.slice(1),!0)}e=tP.eventBuffer.toBeProcessedArray.value}}loadDestinations(){if("destinationsLoading"===tP.lifecycle.status.value||"destinationsReady"===tP.lifecycle.status.value)return;this.pluginsManager?.invokeSingle("nativeDestinations.setActiveDestinations",tP,this.pluginsManager,this.errorHandler,this.logger);let e=tP.nativeDestinations.activeDestinations.value.length;0!==e?(tP.lifecycle.status.value="destinationsLoading",this.pluginsManager?.invokeSingle("nativeDestinations.load",tP,this.externalSrcLoader,this.errorHandler,this.logger),ez(()=>{(0===e||tP.nativeDestinations.initializedDestinations.value.length+tP.nativeDestinations.failedDestinations.value.length===e)&&e9(()=>{tP.lifecycle.status.value="destinationsReady",tP.nativeDestinations.clientDestinationsReady.value=!0})})):tP.lifecycle.status.value="destinationsReady"}onDestinationsReady(){"ready"!==tP.lifecycle.status.value&&(tP.lifecycle.status.value="ready")}ready(e,t=!1){let i="ready";tP.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${i} invocation`),y(e)?"readyExecuted"===tP.lifecycle.status.value?ny(e,[],W,this.logger):tP.eventBuffer.readyCallbacksArray.value=[...tP.eventBuffer.readyCallbacksArray.value,e]:this.logger.error(eZ(W))):tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,[i,e]]}page(e,t=!1){let i="page";tP.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${i} event`),tP.metrics.triggered.value+=1,this.eventManager?.addEvent({type:"page",category:e.category,name:e.name,properties:e.properties,options:e.options,callback:e.callback}),!0===tP.capabilities.isAdBlocked.value&&e.category!==eb&&this.page(N(eb,"ad-block page request",{path:"/ad-blocked"},tP.loadOptions.value.sendAdblockPageOptions))):tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,[i,e]]}track(e,t=!1){let i="track";tP.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${i} event - ${e.name}`),tP.metrics.triggered.value+=1,this.eventManager?.addEvent({type:i,name:e.name||void 0,properties:e.properties,options:e.options,callback:e.callback})):tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,[i,e]]}identify(e,t=!1){let i="identify";tP.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${i} event`),tP.metrics.triggered.value+=1,Boolean(e.userId&&tP.session.userId.value&&e.userId!==tP.session.userId.value)&&this.reset(),b(e.userId)||this.userSessionManager?.setUserId(e.userId),this.userSessionManager?.setUserTraits(e.traits),this.eventManager?.addEvent({type:i,userId:e.userId,traits:e.traits,options:e.options,callback:e.callback})):tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,[i,e]]}alias(e,t=!1){let i="alias";if(!tP.lifecycle.loaded.value)return void(tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,[i,e]]);this.errorHandler.leaveBreadcrumb(`New ${i} event`),tP.metrics.triggered.value+=1;let n=e.from??(this.getUserId()||this.userSessionManager?.getAnonymousId());this.eventManager?.addEvent({type:i,to:e.to,from:n,options:e.options,callback:e.callback})}group(e,t=!1){let i="group";tP.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${i} event`),tP.metrics.triggered.value+=1,b(e.groupId)||this.userSessionManager?.setGroupId(e.groupId),this.userSessionManager?.setGroupTraits(e.traits),this.eventManager?.addEvent({type:i,groupId:e.groupId,traits:e.traits,options:e.options,callback:e.callback})):tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,[i,e]]}reset(e,t=!1){let i="reset";tP.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${i} invocation, resetAnonymousId: ${e}`),this.userSessionManager?.reset(e)):tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,[i,e]]}getAnonymousId(e){return this.userSessionManager?.getAnonymousId(e)}setAnonymousId(e,t,i=!1){let n="setAnonymousId";tP.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${n} invocation`),this.userSessionManager?.setAnonymousId(e,t)):tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,[n,e,t]]}getUserId(){return tP.session.userId.value}getUserTraits(){return tP.session.userTraits.value}getGroupId(){return tP.session.groupId.value}getGroupTraits(){return tP.session.groupTraits.value}startSession(e,t=!1){let i="startSession";tP.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${i} invocation`),this.userSessionManager?.start(e)):tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,[i,e]]}endSession(e=!1){let t="endSession";tP.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb(`New ${t} invocation`),this.userSessionManager?.end()):tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,[t]]}getSessionId(){return this.userSessionManager?.getSessionId()??null}consent(e,t=!1){tP.lifecycle.loaded.value?(this.errorHandler.leaveBreadcrumb("New consent invocation"),e9(()=>{tP.consents.preConsent.value={...tP.consents.preConsent.value,enabled:!1},tP.consents.postConsent.value=(e=>{let t={sendPageEvent:!1,trackConsent:!1,discardPreConsentEvents:!1};if(w(e)){let i=d(e);t.storage=i.storage,C(i.integrations)&&(t.integrations=i.integrations),t.discardPreConsentEvents=!0===i.discardPreConsentEvents,t.sendPageEvent=!0===i.sendPageEvent,t.trackConsent=!0===i.trackConsent,C(i.consentManagement)&&(t.consentManagement=P(i.consentManagement,{enabled:tP.consents.enabled.value}))}return t})(e);let{initialized:t,consentsData:i}=iW(tP.consents.postConsent.value.consentManagement,this.logger);tP.consents.initialized.value=t,tP.consents.data.value=i}),tP.consents.enabled.value&&!tP.consents.initialized.value&&this.pluginsManager?.invokeSingle("consentManager.updateConsentsInfo",tP,this.storeManager,this.logger),this.storeManager?.initializeStorageState(),this.userSessionManager?.syncStorageDataToState(),this.eventManager?.resume(),this.loadDestinations(),this.sendTrackingEvents(t)):tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,["consent",e]]}sendTrackingEvents(e){if(tP.consents.postConsent.value.trackConsent){let t=L("Consent Management Interaction");e?tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,["track",t]]:this.track(t)}if(tP.consents.postConsent.value.sendPageEvent){let i=N();e?tP.eventBuffer.toBeProcessedArray.value=[...tP.eventBuffer.toBeProcessedArray.value,["page",i]]:this.page(i)}}setAuthToken(e){this.userSessionManager?.setAuthToken(e)}}class n${static globalSingleton=null;analyticsInstances={};defaultAnalyticsKey="";logger=eq;constructor(){try{if(n$.globalSingleton)return n$.globalSingleton;n$.initializeGlobalResources(),this.setDefaultInstanceKey=this.setDefaultInstanceKey.bind(this),this.getAnalyticsInstance=this.getAnalyticsInstance.bind(this),this.load=this.load.bind(this),this.ready=this.ready.bind(this),this.triggerBufferedLoadEvent=this.triggerBufferedLoadEvent.bind(this),this.page=this.page.bind(this),this.track=this.track.bind(this),this.identify=this.identify.bind(this),this.alias=this.alias.bind(this),this.group=this.group.bind(this),this.reset=this.reset.bind(this),this.getAnonymousId=this.getAnonymousId.bind(this),this.setAnonymousId=this.setAnonymousId.bind(this),this.getUserId=this.getUserId.bind(this),this.getUserTraits=this.getUserTraits.bind(this),this.getGroupId=this.getGroupId.bind(this),this.getGroupTraits=this.getGroupTraits.bind(this),this.startSession=this.startSession.bind(this),this.endSession=this.endSession.bind(this),this.getSessionId=this.getSessionId.bind(this),this.setAuthToken=this.setAuthToken.bind(this),this.consent=this.consent.bind(this),n$.globalSingleton=this,tP.autoTrack.pageLifecycle.pageViewId.value=er(),tP.autoTrack.pageLifecycle.pageLoadedTimestamp.value=Date.now(),this.triggerBufferedLoadEvent(),globalThis.kepixelAnalytics=this}catch(e){ef(e)}}static initializeGlobalResources(){t7.init(),iU.configure(),iB.configure(),i8.configure(),iC.configure()}setDefaultInstanceKey(e){m(e)&&e&&(this.defaultAnalyticsKey=e)}getAnalyticsInstance(e){try{let t=e;return m(t)&&t||(t=this.defaultAnalyticsKey),Boolean(this.analyticsInstances[t])||(this.analyticsInstances[t]=new nk),this.analyticsInstances[t]}catch(i){return void ef(i)}}load(e,t,i){try{if(this.analyticsInstances[e])return;this.setDefaultInstanceKey(e),this.trackPageLifecycleEvents(i);let n=ew(ek);(e=>{let t="consent",i=e.filter(e=>e[0]===t),n=e.filter(e=>e[0]!==t);e.splice(0,e.length,...i,...n)})(n),eA(ek,d(n)),this.getAnalyticsInstance(e)?.load(e,t,eg(i))}catch(r){ef(r)}}trackPageLifecycleEvents(e){let{autoTrack:t,useBeacon:i}=e??{},{enabled:n=!1,options:r={},pageLifecycle:s}=t??{},{events:a=[K.UNLOADED],enabled:o=n,options:l=r}=s??{};tP.autoTrack.pageLifecycle.enabled.value=o,tP.autoTrack.enabled.value=n||o,o&&this.setupPageUnloadTracking(a,i,l)}setupPageUnloadTracking(e,t,i){(0===e.length||e.includes(K.UNLOADED))&&(!0===t?(e=>{let t=!1,i=!1;function n(){t||(t=!0,e(i),setTimeout(()=>{t=!1},0))}globalThis.addEventListener("beforeunload",()=>{i=!1,n()}),globalThis.addEventListener("blur",()=>{i=!0,n()}),globalThis.addEventListener("focus",()=>{t=!1}),document.addEventListener("pagehide",()=>{i="hidden"===document.visibilityState,n()}),document.addEventListener("visibilitychange",()=>{i=!0,"hidden"===document.visibilityState?n():t=!1})})(e=>{if(!1===e&&tP.lifecycle.loaded.value){let t=Date.now(),n=t-tP.autoTrack.pageLifecycle.pageLoadedTimestamp.value;this.track(K.UNLOADED,{timeOnPage:n},{...i,originalTimestamp:es(new Date(t))})}}):this.logger.warn('KePixelStackAnalytics:: Page Unloaded event can only be tracked when the Beacon transport is active. Please enable "useBeacon" load API option.'))}triggerBufferedLoadEvent(){let e=Array.isArray(globalThis.kepixelAnalytics)?globalThis.kepixelAnalytics:[],t=(e=>{let t=[],i=0;for(;i<e.length;){if(e[i]&&"load"===e[i][0]){t=d(e[i]),e.splice(i,1);break}i+=1}return t})(e);eA(ek,d([...e])),t.length>0&&(t.shift(),this.load.apply(null,t))}ready(e){try{this.getAnalyticsInstance()?.ready(eg(e))}catch(t){ef(t)}}page(e,t,i,n,r){try{this.getAnalyticsInstance()?.page(N(eg(e),eg(t),eg(i),eg(n),eg(r)))}catch(s){ef(s)}}track(e,t,i,n){try{this.getAnalyticsInstance()?.track(L(eg(e),eg(t),eg(i),eg(n)))}catch(r){ef(r)}}identify(e,t,i,n){try{this.getAnalyticsInstance()?.identify(B(eg(e),eg(t),eg(i),eg(n)))}catch(r){ef(r)}}alias(e,t,i,n){try{this.getAnalyticsInstance()?.alias(U(eg(e),eg(t),eg(i),eg(n)))}catch(r){ef(r)}}group(e,t,i,n){try{this.getAnalyticsInstance()?.group(H(eg(e),eg(t),eg(i),eg(n)))}catch(r){ef(r)}}reset(e){try{this.getAnalyticsInstance()?.reset(eg(e))}catch(t){ef(t)}}getAnonymousId(e){try{return this.getAnalyticsInstance()?.getAnonymousId(eg(e))}catch(t){return void ef(t)}}setAnonymousId(e,t){try{this.getAnalyticsInstance()?.setAnonymousId(eg(e),eg(t))}catch(i){ef(i)}}getUserId(){try{return this.getAnalyticsInstance()?.getUserId()}catch(e){return void ef(e)}}getUserTraits(){try{return this.getAnalyticsInstance()?.getUserTraits()}catch(e){return void ef(e)}}getGroupId(){try{return this.getAnalyticsInstance()?.getGroupId()}catch(e){return void ef(e)}}getGroupTraits(){try{return this.getAnalyticsInstance()?.getGroupTraits()}catch(e){return void ef(e)}}startSession(e){try{this.getAnalyticsInstance()?.startSession(eg(e))}catch(t){ef(t)}}endSession(){try{this.getAnalyticsInstance()?.endSession()}catch(e){ef(e)}}getSessionId(){try{return this.getAnalyticsInstance()?.getSessionId()}catch(e){return void ef(e)}}setAuthToken(e){try{this.getAnalyticsInstance()?.setAuthToken(eg(e))}catch(t){ef(t)}}consent(e){try{this.getAnalyticsInstance()?.consent(eg(e))}catch(t){ef(t)}}}let{setDefaultInstanceKey:nI,getAnalyticsInstance:nS,load:nE,ready:nA,page:nw,track:nT,identify:nP,alias:nC,group:n_,reset:nD,getAnonymousId:n9,setAnonymousId:nx,getUserId:nO,getUserTraits:nR,getGroupId:nM,getGroupTraits:nN,startSession:nL,endSession:nB,getSessionId:n8,consent:nU,setAuthToken:nH}=new n$;return e.alias=nC,e.consent=nU,e.endSession=nB,e.getAnalyticsInstance=nS,e.getAnonymousId=n9,e.getGroupId=nM,e.getGroupTraits=nN,e.getSessionId=n8,e.getUserId=nO,e.getUserTraits=nR,e.group=n_,e.identify=nP,e.load=nE,e.page=nw,e.ready=nA,e.reset=nD,e.setAnonymousId=nx,e.setAuthToken=nH,e.setDefaultInstanceKey=nI,e.startSession=nL,e.track=nT,Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),e}({});
